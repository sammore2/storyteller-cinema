{"version":3,"file":"main.js","sources":["../src/scripts/main.js"],"sourcesContent":["import '../styles/style.scss';\r\nimport { toggleCinematicMode, createOverlay } from './core/cinematic.js';\r\nimport { applyVisualDepth } from './core/depth.js';\r\nimport { registerUIHooks } from './hooks/ui.js';\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* INIT HOOK                                                                 */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.once('init', async function () {\r\n  console.log('Storyteller Cinema | Initializing...');\r\n\r\n  // 1. REGISTER SETTINGS (INLINE to guarantee availability)\r\n  game.settings.register('storyteller-cinema', 'referenceHeight', {\r\n    name: \"Reference Height (%)\",\r\n    hint: \"Percentage of the scene height that the token should occupy when at the front.\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 30, // 30% da tela\r\n    range: { min: 10, max: 100, step: 5 }\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'minScale', {\r\n    name: \"Min Depth Scale\",\r\n    hint: \"Scale multiplier at the top of the screen (background).\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 0.5,\r\n    range: { min: 0.1, max: 1.0, step: 0.1 }\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'maxScale', {\r\n    name: \"Max Depth Scale\",\r\n    hint: \"Scale multiplier at the bottom of the screen (foreground).\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 1.2,\r\n    range: { min: 1.0, max: 3.0, step: 0.1 }\r\n  });\r\n\r\n  // 2. Setup Overlay\r\n  createOverlay();\r\n\r\n  // 3. Register UI Logic\r\n  registerUIHooks();\r\n\r\n  // 4. Keybindings\r\n  game.keybindings.register('storyteller-cinema', 'toggle-mode', {\r\n    name: \"Toggle Cinematic Mode\",\r\n    hint: \"Switch between Battle Map and Visual Novel views\",\r\n    editable: [{ key: \"KeyZ\", modifiers: [\"Shift\"] }],\r\n    onDown: () => {\r\n      const isCinematic = document.body.classList.contains('cinematic-mode');\r\n      toggleCinematicMode(!isCinematic);\r\n    },\r\n    restricted: false,\r\n    precedence: CONST.KEYBINDING_PRECEDENCE.NORMAL\r\n  });\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* CANVAS READY                                                              */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('canvasReady', () => {\r\n  const viewMode = canvas.scene.getFlag('storyteller-cinema', 'viewMode');\r\n  const shouldBeCinematic = viewMode === 'cinematic';\r\n\r\n  // Use init: true to prevent transition animations if desired, or let it animate.\r\n  // Generally on load we might want instant switch, but toggleCinematicMode handles mechanics.\r\n  toggleCinematicMode(shouldBeCinematic, { init: true });\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* UPDATE TOKEN (Reactive Memory + Visual Depth)                             */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('updateToken', (tokenDocument, change, options) => {\r\n  if (!change.x && !change.y) return;\r\n  if (change.flags?.['storyteller-cinema']) return;\r\n  if (options.skippingMemory) return;\r\n\r\n  // Simple Try/Catch just for safety\r\n  try {\r\n    if (game.user.isGM || tokenDocument.isOwner) {\r\n      const isCinematic = document.body.classList.contains('cinematic-mode');\r\n      const targetFlag = isCinematic ? 'cinematicPos' : 'battlePos';\r\n      const newPos = { x: change.x ?? tokenDocument.x, y: change.y ?? tokenDocument.y };\r\n\r\n      tokenDocument.setFlag('storyteller-cinema', targetFlag, newPos);\r\n\r\n      if (isCinematic && tokenDocument.object) {\r\n        applyVisualDepth(tokenDocument.object);\r\n      }\r\n    }\r\n  } catch (err) {\r\n    console.error(\"Storyteller Cinema | Update Error:\", err);\r\n  }\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* REFRESH TOKEN (Visual Lock: Size & Rotation)                              */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('refreshToken', (token) => {\r\n  if (document.body.classList.contains('cinematic-mode')) {\r\n    applyVisualDepth(token);\r\n  }\r\n});\r\n\r\nconsole.log(\"Storyteller Cinema | Main Loaded (Inlined)\");\r\n"],"names":[],"mappings":";;;AAQA,MAAM,KAAK,QAAQ,iBAAkB;AACnC,UAAQ,IAAI,sCAAsC;AAGlD,OAAK,SAAS,SAAS,sBAAsB,mBAAmB;AAAA,IAC9D,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA;AAAA,IACT,OAAO,EAAE,KAAK,IAAI,KAAK,KAAK,MAAM,EAAC;AAAA,EACvC,CAAG;AAED,OAAK,SAAS,SAAS,sBAAsB,YAAY;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,IACT,OAAO,EAAE,KAAK,KAAK,KAAK,GAAK,MAAM,IAAG;AAAA,EAC1C,CAAG;AAED,OAAK,SAAS,SAAS,sBAAsB,YAAY;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,IACT,OAAO,EAAE,KAAK,GAAK,KAAK,GAAK,MAAM,IAAG;AAAA,EAC1C,CAAG;AAGD;AAGA;AAGA,OAAK,YAAY,SAAS,sBAAsB,eAAe;AAAA,IAC7D,MAAM;AAAA,IACN,MAAM;AAAA,IACN,UAAU,CAAC,EAAE,KAAK,QAAQ,WAAW,CAAC,OAAO,GAAG;AAAA,IAChD,QAAQ,MAAM;AACZ,YAAM,cAAc,SAAS,KAAK,UAAU,SAAS,gBAAgB;AACrE,0BAAoB,CAAC,WAAW;AAAA,IAClC;AAAA,IACA,YAAY;AAAA,IACZ,YAAY,MAAM,sBAAsB;AAAA,EAC5C,CAAG;AACH,CAAC;AAKD,MAAM,GAAG,eAAe,MAAM;AAC5B,QAAM,WAAW,OAAO,MAAM,QAAQ,sBAAsB,UAAU;AACtE,QAAM,oBAAoB,aAAa;AAIvC,sBAAoB,mBAAmB,CAAa,CAAC;AACvD,CAAC;AAKD,MAAM,GAAG,eAAe,CAAC,eAAe,QAAQ,YAAY;;AAC1D,MAAI,CAAC,OAAO,KAAK,CAAC,OAAO,EAAG;AAC5B,OAAI,YAAO,UAAP,mBAAe,sBAAuB;AAC1C,MAAI,QAAQ,eAAgB;AAG5B,MAAI;AACF,QAAI,KAAK,KAAK,QAAQ,cAAc,SAAS;AAC3C,YAAM,cAAc,SAAS,KAAK,UAAU,SAAS,gBAAgB;AACrE,YAAM,aAAa,cAAc,iBAAiB;AAClD,YAAM,SAAS,EAAE,GAAG,OAAO,KAAK,cAAc,GAAG,GAAG,OAAO,KAAK,cAAc,EAAC;AAE/E,oBAAc,QAAQ,sBAAsB,YAAY,MAAM;AAE9D,UAAI,eAAe,cAAc,QAAQ;AACvC,yBAAiB,cAAc,MAAM;AAAA,MACvC;AAAA,IACF;AAAA,EACF,SAAS,KAAK;AACZ,YAAQ,MAAM,sCAAsC,GAAG;AAAA,EACzD;AACF,CAAC;AAKD,MAAM,GAAG,gBAAgB,CAAC,UAAU;AAClC,MAAI,SAAS,KAAK,UAAU,SAAS,gBAAgB,GAAG;AACtD,qBAAiB,KAAK;AAAA,EACxB;AACF,CAAC;AAED,QAAQ,IAAI,4CAA4C;"}