{"version":3,"file":"main.js","sources":["../src/scripts/main.js"],"sourcesContent":["import '../styles/style.scss';\r\n\r\nHooks.once('init', async function () {\r\n  console.log('Storyteller Cinema | Iniciado');\r\n\r\n  // Register World Settings for Scale Limits\r\n  game.settings.register('storyteller-cinema', 'minScale', {\r\n    name: 'Escala Mínima (Fundo)',\r\n    hint: 'Tamanho do token quando estiver no topo da cena (0.0 a 1.0).',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    default: 0.6\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'maxScale', {\r\n    name: 'Escala Máxima (Frente)',\r\n    hint: 'Tamanho do token quando estiver na parte inferior da cena (1.0 ou mais).',\r\n    scope: 'world',\r\n    config: true,\r\n    type: Number,\r\n    default: 1.2\r\n  });\r\n});\r\n\r\n/**\r\n * Adds the Cinematic Mode toggle button to the Token Layer controls.\r\n */\r\nHooks.on('getSceneControlButtons', (controls) => {\r\n  const tokenControls = controls.find(c => c.name === 'token');\r\n  if (tokenControls) {\r\n    tokenControls.tools.push({\r\n      name: 'cinematic',\r\n      title: 'Modo Cinema',\r\n      icon: 'fas fa-film',\r\n      toggle: true,\r\n      active: document.body.classList.contains('cinematic-mode'),\r\n      onClick: (toggled) => {\r\n        if (toggled) document.body.classList.add('cinematic-mode');\r\n        else document.body.classList.remove('cinematic-mode');\r\n      }\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * Applies visual depth scaling to tokens based on their Y position.\r\n * This effect is purely visual (Client-Side) and alters the Mesh scale.\r\n */\r\nHooks.on('updateToken', (tokenDocument, changes, context, userId) => {\r\n  // Only apply if strictly necessary changes occurred (y position) or on full refresh logic\r\n  if (!changes.y && !changes.x) return;\r\n\r\n  const token = tokenDocument.object;\r\n  if (!token || !token.scene) return;\r\n\r\n  const sceneHeight = token.scene.dimensions.height;\r\n  const tokenY = token.y;\r\n\r\n  // Calculate ratio (0 at top, 1 at bottom)\r\n  const ratio = Math.max(0, Math.min(1, tokenY / sceneHeight));\r\n\r\n  const minScale = game.settings.get('storyteller-cinema', 'minScale');\r\n  const maxScale = game.settings.get('storyteller-cinema', 'maxScale');\r\n\r\n  // Interpolate scale\r\n  const newScale = minScale + (ratio * (maxScale - minScale));\r\n\r\n  // Apply to Mesh only (does not save to DB)\r\n  token.mesh.scale.set(newScale);\r\n});\r\n\r\n// Also apply scale on Token Refresh/Draw to ensure initial state is correct\r\nHooks.on('refreshToken', (token) => {\r\n  if (!token.scene) return;\r\n  const sceneHeight = token.scene.dimensions.height;\r\n  const ratio = Math.max(0, Math.min(1, token.y / sceneHeight));\r\n  const minScale = game.settings.get('storyteller-cinema', 'minScale');\r\n  const maxScale = game.settings.get('storyteller-cinema', 'maxScale');\r\n  const newScale = minScale + (ratio * (maxScale - minScale));\r\n  token.mesh.scale.set(newScale);\r\n});\r\n\r\n\r\n/**\r\n * Injects the \"Mood\" selection into the Scene Configuration dialog logic.\r\n * Note: Since V13 API might change how ApplicationV2 works, sticking to standard JQuery injection for 'renderSceneConfig' is safest for now unless AppV2 is strictly required.\r\n * Assuming standard FormApplication behavior for SceneConfig.\r\n */\r\nHooks.on('renderSceneConfig', (app, html, data) => {\r\n  const mood = app.object.getFlag('storyteller-cinema', 'mood') || 'Normal';\r\n\r\n  const formGroup = `\r\n  < div class=\"form-group\" >\r\n      <label>Mood Cinemático</label>\r\n      <div class=\"form-fields\">\r\n        <select name=\"flags.storyteller-cinema.mood\">\r\n          <option value=\"Normal\" ${mood === 'Normal' ? 'selected' : ''}>Normal</option>\r\n          <option value=\"Noir\" ${mood === 'Noir' ? 'selected' : ''}>Noir</option>\r\n          <option value=\"Blood\" ${mood === 'Blood' ? 'selected' : ''}>Blood</option>\r\n        </select>\r\n      </div>\r\n      <p class=\"notes\">Define um filtro visual global para esta cena.</p>\r\n    </div >\r\n  `;\r\n\r\n  // Inject into the \"Basic\" tab (usually the first tab)\r\n  html.find('div[data-tab=\"basic\"] .form-group').last().after(formGroup);\r\n});\r\n\r\n/**\r\n * Applies the specific Scene Mood filter when the Canvas is ready.\r\n */\r\nHooks.on('canvasReady', (canvas) => {\r\n  // Remove existing filters\r\n  document.body.classList.remove('filter-noir', 'filter-blood');\r\n\r\n  const mood = canvas.scene.getFlag('storyteller-cinema', 'mood');\r\n  if (mood === 'Noir') {\r\n    document.body.classList.add('filter-noir');\r\n  } else if (mood === 'Blood') {\r\n    document.body.classList.add('filter-blood');\r\n  }\r\n});\r\n"],"names":["controls","tokenControls","c","toggled","tokenDocument","changes","context","userId","token","sceneHeight","tokenY","ratio","minScale","maxScale","newScale","app","html","data","mood","formGroup","canvas"],"mappings":"AAEA,MAAM,KAAK,QAAQ,iBAAkB;AACnC,UAAQ,IAAI,+BAA+B,GAG3C,KAAK,SAAS,SAAS,sBAAsB,YAAY;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EACb,CAAG,GAED,KAAK,SAAS,SAAS,sBAAsB,YAAY;AAAA,IACvD,MAAM;AAAA,IACN,MAAM;AAAA,IACN,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,SAAS;AAAA,EACb,CAAG;AACH,CAAC;AAKD,MAAM,GAAG,0BAA0B,CAACA,MAAa;AAC/C,QAAMC,IAAgBD,EAAS,KAAK,CAAAE,MAAKA,EAAE,SAAS,OAAO;AAC3D,EAAID,KACFA,EAAc,MAAM,KAAK;AAAA,IACvB,MAAM;AAAA,IACN,OAAO;AAAA,IACP,MAAM;AAAA,IACN,QAAQ;AAAA,IACR,QAAQ,SAAS,KAAK,UAAU,SAAS,gBAAgB;AAAA,IACzD,SAAS,CAACE,MAAY;AACpB,MAAIA,IAAS,SAAS,KAAK,UAAU,IAAI,gBAAgB,IACpD,SAAS,KAAK,UAAU,OAAO,gBAAgB;AAAA,IACtD;AAAA,EACN,CAAK;AAEL,CAAC;AAMD,MAAM,GAAG,eAAe,CAACC,GAAeC,GAASC,GAASC,MAAW;AAEnE,MAAI,CAACF,EAAQ,KAAK,CAACA,EAAQ,EAAG;AAE9B,QAAMG,IAAQJ,EAAc;AAC5B,MAAI,CAACI,KAAS,CAACA,EAAM,MAAO;AAE5B,QAAMC,IAAcD,EAAM,MAAM,WAAW,QACrCE,IAASF,EAAM,GAGfG,IAAQ,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGD,IAASD,CAAW,CAAC,GAErDG,IAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,GAC7DC,IAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,GAG7DC,IAAWF,IAAYD,KAASE,IAAWD;AAGjD,EAAAJ,EAAM,KAAK,MAAM,IAAIM,CAAQ;AAC/B,CAAC;AAGD,MAAM,GAAG,gBAAgB,CAACN,MAAU;AAClC,MAAI,CAACA,EAAM,MAAO;AAClB,QAAMC,IAAcD,EAAM,MAAM,WAAW,QACrCG,IAAQ,KAAK,IAAI,GAAG,KAAK,IAAI,GAAGH,EAAM,IAAIC,CAAW,CAAC,GACtDG,IAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,GAC7DC,IAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,GAC7DC,IAAWF,IAAYD,KAASE,IAAWD;AACjD,EAAAJ,EAAM,KAAK,MAAM,IAAIM,CAAQ;AAC/B,CAAC;AAQD,MAAM,GAAG,qBAAqB,CAACC,GAAKC,GAAMC,MAAS;AACjD,QAAMC,IAAOH,EAAI,OAAO,QAAQ,sBAAsB,MAAM,KAAK,UAE3DI,IAAY;AAAA;AAAA;AAAA;AAAA;AAAA,mCAKeD,MAAS,WAAW,aAAa,EAAE;AAAA,iCACrCA,MAAS,SAAS,aAAa,EAAE;AAAA,kCAChCA,MAAS,UAAU,aAAa,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAQlE,EAAAF,EAAK,KAAK,mCAAmC,EAAE,KAAI,EAAG,MAAMG,CAAS;AACvE,CAAC;AAKD,MAAM,GAAG,eAAe,CAACC,MAAW;AAElC,WAAS,KAAK,UAAU,OAAO,eAAe,cAAc;AAE5D,QAAMF,IAAOE,EAAO,MAAM,QAAQ,sBAAsB,MAAM;AAC9D,EAAIF,MAAS,SACX,SAAS,KAAK,UAAU,IAAI,aAAa,IAChCA,MAAS,WAClB,SAAS,KAAK,UAAU,IAAI,cAAc;AAE9C,CAAC;"}