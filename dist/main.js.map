{"version":3,"file":"main.js","sources":["../src/scripts/main.js"],"sourcesContent":["import '../styles/style.scss';\r\nimport { StorytellerAPI } from './core/api.js';\r\nimport { SkinManager } from './core/skin-manager.js';\r\nimport { applyVisualDepth } from './core/depth.js';\r\nimport { registerUIHooks } from './hooks/ui.js';\r\nimport './lib/shim.js'; // Import libWrapper Shim\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* INIT HOOK                                                                 */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.once('init', async function () {\r\n  console.log('Storyteller Cinema | Initializing...');\r\n\r\n  // 1. REGISTER SETTINGS (MUST BE FIRST)\r\n  game.settings.register('storyteller-cinema', 'activeSkin', {\r\n    name: \"Active Skin\",\r\n    scope: \"client\", // Client specific preference\r\n    config: false,   // Hidden from menu, managed by Skin UI\r\n    type: String,\r\n    default: 'default',\r\n    onChange: (value) => {\r\n      if (window.StorytellerCinema?.skins) {\r\n        window.StorytellerCinema.skins.apply(value);\r\n      }\r\n    }\r\n  });\r\n  game.settings.register('storyteller-cinema', 'customSkins', {\r\n    name: \"Custom Skins\",\r\n    scope: \"client\", // Stored locally per user (or world if shared needed)\r\n    config: false,\r\n    type: Array,\r\n    default: []\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'referenceHeight', {\r\n    name: \"Reference Height (%)\",\r\n    hint: \"Token height relative to the screen height.\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 35,\r\n    range: { min: 10, max: 80, step: 5 }\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'minScale', {\r\n    name: \"Min Depth Scale\",\r\n    hint: \"Scale multiplier at the top (background).\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 0.5,\r\n    range: { min: 0.1, max: 1.0, step: 0.1 }\r\n  });\r\n\r\n  game.settings.register('storyteller-cinema', 'maxScale', {\r\n    name: \"Max Depth Scale\",\r\n    hint: \"Scale multiplier at the bottom (foreground).\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Number,\r\n    default: 1.2,\r\n    range: { min: 1.0, max: 3.0, step: 0.1 }\r\n  });\r\n\r\n  // 0. INITIALIZE API\r\n  window.StorytellerCinema = new StorytellerAPI();\r\n  window.StorytellerCinema.skins = new SkinManager(); // Attach Manager\r\n\r\n  window.StorytellerCinema.init();\r\n  window.StorytellerCinema.skins.init(); // Initialize Skins\r\n\r\n  // REGISTER LIBWRAPPER HOOK (Canvas Visibility Override)\r\n  // Target: 'foundry.canvas.groups.CanvasVisibility.prototype.tokenVision' (V13 Namespace)\r\n  // Logic: Use CanvasVisibility to control the global \"Active\" state of token vision.\r\n  // If we return 'false', the system assumes Token Vision is disabled for the current render frame,\r\n  // showing the full scene (assuming Global Light is active).\r\n  const visTarget = 'foundry.canvas.groups.CanvasVisibility.prototype.tokenVision';\r\n\r\n  try {\r\n    libWrapper.register('storyteller-cinema', visTarget, function (wrapped, ...args) {\r\n      if (window.StorytellerCinema?.active) return false;\r\n      return wrapped(...args);\r\n    }, 'MIXED');\r\n    console.log(\"Storyteller Cinema | Hook registered on\", visTarget);\r\n  } catch (err) {\r\n    console.warn(\"Storyteller Cinema | Failed to register Visibility wrapper:\", err);\r\n    // Fallback: Try global 'CanvasVisibility' if namespace fails?\r\n    try {\r\n      libWrapper.register('storyteller-cinema', 'CanvasVisibility.prototype.tokenVision', function (wrapped, ...args) {\r\n        if (window.StorytellerCinema?.active) return false;\r\n        return wrapped(...args);\r\n      }, 'MIXED');\r\n      console.log(\"Storyteller Cinema | Hook registered on Global CanvasVisibility\");\r\n    } catch (e2) {\r\n      console.error(\"Storyteller Cinema | ALL wrapper attempts failed:\", e2);\r\n    }\r\n  }\r\n\r\n  // REGISTER LIBWRAPPER HOOK (Collision Bypass - Geometry Engine)\r\n  // Target: 'foundry.canvas.geometry.ClockwiseSweepPolygon.testCollision'\r\n  // Logic: This is the deepest level check. If we return false here, NO collision is detected by ANY system layer.\r\n  // This solves the issue where WallsLayer or Token checks might be bypassed or implemented differently.\r\n  const polygonTarget = 'foundry.canvas.geometry.ClockwiseSweepPolygon.testCollision';\r\n  try {\r\n    libWrapper.register('storyteller-cinema', polygonTarget, function (wrapped, ...args) {\r\n      if (window.StorytellerCinema?.active) return false;\r\n      return wrapped(...args);\r\n    }, 'MIXED');\r\n    console.log(\"Storyteller Cinema | Hook registered on\", polygonTarget);\r\n  } catch (err) {\r\n    console.warn(\"Storyteller Cinema | Failed to register Polygon collision wrapper:\", err);\r\n  }\r\n\r\n  // 2. SETUP UI HOOKS\r\n  registerUIHooks();\r\n\r\n  // 3. KEYBINDINGS\r\n  game.keybindings.register('storyteller-cinema', 'toggle-mode', {\r\n    name: \"Toggle Cinematic Mode\",\r\n    hint: \"Switch view\",\r\n    editable: [{ key: \"KeyZ\", modifiers: [\"Shift\"] }],\r\n    onDown: () => {\r\n      if (game.user.isGM) {\r\n        const current = canvas.scene.getFlag('storyteller-cinema', 'active');\r\n        canvas.scene.setFlag('storyteller-cinema', 'active', !current);\r\n      }\r\n    },\r\n    restricted: false\r\n  });\r\n\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* CANVAS READY                                                              */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('canvasReady', () => {\r\n  // API handles check internal? No, check flag.\r\n  const viewMode = canvas.scene.getFlag('storyteller-cinema', 'viewMode');\r\n  const isActive = canvas.scene.getFlag('storyteller-cinema', 'active') || false;\r\n  const shouldBeCinematic = isActive || viewMode === 'cinematic';\r\n\r\n  // Call API\r\n  window.StorytellerCinema.toggle(shouldBeCinematic, { init: true });\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* UPDATE SCENE (The Critical Hook)                                          */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('updateScene', async (document, change, options, userId) => {\r\n  if (!document.isView) return;\r\n\r\n  const activeChange = change.flags?.['storyteller-cinema']?.active;\r\n  if (activeChange !== undefined) {\r\n    // Stack Delay for Vision Safety\r\n    setTimeout(() => {\r\n      window.StorytellerCinema.toggle(activeChange);\r\n    }, 50);\r\n  }\r\n\r\n  // Background Update\r\n  if (window.StorytellerCinema.active) {\r\n    const flagChange = change.flags?.['storyteller-cinema']?.cinematicBg;\r\n    if (flagChange !== undefined) {\r\n      // Re-trigger toggle true to refresh BG\r\n      window.StorytellerCinema.toggle(true);\r\n    }\r\n\r\n    // Enforce Vision (Race Condition Guard)\r\n    window.StorytellerCinema.enforceVision();\r\n  }\r\n});\r\n\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* UPDATE TOKEN (Reactive Memory + Visual Depth)                             */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('updateToken', (tokenDocument, change, options) => {\r\n  if (!change.x && !change.y) return;\r\n  if (change.flags?.['storyteller-cinema']) return;\r\n  if (options.skippingMemory) return;\r\n\r\n  try {\r\n    if (game.user.isGM || tokenDocument.isOwner) {\r\n      const isCinematic = window.StorytellerCinema?.active;\r\n      const targetFlag = isCinematic ? 'cinematicPos' : 'battlePos';\r\n      const newPos = { x: change.x ?? tokenDocument.x, y: change.y ?? tokenDocument.y };\r\n\r\n      tokenDocument.setFlag('storyteller-cinema', targetFlag, newPos);\r\n\r\n      if (isCinematic && tokenDocument.object) {\r\n        applyVisualDepth(tokenDocument.object);\r\n      }\r\n    }\r\n  } catch (err) {\r\n    console.error(\"Storyteller Cinema | Update Error:\", err);\r\n  }\r\n});\r\n\r\n/* ------------------------------------------------------------------------- */\r\n/* REFRESH TOKEN (Visual Lock: Size & Rotation)                              */\r\n/* ------------------------------------------------------------------------- */\r\nHooks.on('refreshToken', (token) => {\r\n  if (window.StorytellerCinema?.active) {\r\n    applyVisualDepth(token);\r\n  }\r\n});\r\n"],"names":[],"mappings":"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"}