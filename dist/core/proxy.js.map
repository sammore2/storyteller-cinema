{"version":3,"file":"proxy.js","sources":["../../src/scripts/core/proxy.js"],"sourcesContent":["/**\r\n * CinematicProxy\r\n * \r\n * Uma entidade visual (PIXI.Container) que substitui visualmente o Token na cena.\r\n * - Usa a imagem do ATOR (Full Body) se disponÃ­vel.\r\n * - Aplica o efeito Standee (2.5D, RotaÃ§Ã£o 0, Flip).\r\n * - Segue o Token invisÃ­vel (Controller).\r\n */\r\nexport class CinematicProxy {\r\n    constructor(token) {\r\n        this.token = token;\r\n        this.sprite = new PIXI.Sprite();\r\n        this.container = new PIXI.Container();\r\n\r\n        // Settings with Safe Defaults\r\n        const getSetting = (key, def) => {\r\n            try { return game.settings.get('storyteller-cinema', key); }\r\n            catch { return def; }\r\n        };\r\n\r\n        this.settings = {\r\n            refHeight: (getSetting('referenceHeight', 30)) / 100,\r\n            minDepth: getSetting('minScale', 0.5),\r\n            maxDepth: getSetting('maxScale', 1.2)\r\n        };\r\n\r\n        this._initialized = false;\r\n\r\n        this.init();\r\n    }\r\n\r\n    async init() {\r\n        if (!this.token.actor) return;\r\n\r\n        const imgSrc = this.token.actor.img || this.token.document.texture.src;\r\n        console.log(`Storyteller Cinema | ðŸŽ­ Init Proxy for ${this.token.name}. Image: ${imgSrc}`);\r\n\r\n        try {\r\n            // V13 SAFE: Namespace correto para evitar warnings\r\n            // foundry.canvas.TextureLoader.loader.loadTexture retorna Promise<PIXI.Texture>\r\n            this.texture = await foundry.canvas.TextureLoader.loader.loadTexture(imgSrc);\r\n        } catch (err) {\r\n            console.error(\"Storyteller Cinema | âŒ Texture Load Failed:\", err);\r\n            this.texture = null;\r\n        }\r\n\r\n        // SALVAGUARDA SUPREMA:\r\n        let safeTexture = this.texture;\r\n\r\n        // Helper para validar textura\r\n        const isValidTex = (t) => t && (t instanceof PIXI.Texture) && t.valid;\r\n\r\n        if (!isValidTex(safeTexture)) {\r\n            console.warn(`Storyteller Cinema | âš ï¸ Invalid Texture for ${this.token.name}. Trying fallback.`);\r\n\r\n            if (isValidTex(this.token.mesh?.texture)) {\r\n                safeTexture = this.token.mesh.texture;\r\n            } else {\r\n                console.warn(\"Storyteller Cinema | âš ï¸ Fallback to EMPTY texture.\");\r\n                // Garante que PIXI.Texture.EMPTY existe, senÃ£o cria uma nova\r\n                safeTexture = PIXI.Texture?.EMPTY || new PIXI.Texture(new PIXI.BaseTexture());\r\n            }\r\n        }\r\n\r\n        // Ãšltima verificaÃ§Ã£o antes de atribuir\r\n        if (!safeTexture) {\r\n            console.error(\"Storyteller Cinema | âŒ Could not find ANY valid texture. Aborting Sprite creation.\");\r\n            return;\r\n        }\r\n\r\n        // AtribuiÃ§Ã£o Blindada\r\n        try {\r\n            this.sprite.texture = safeTexture;\r\n        } catch (pixiError) {\r\n            console.error(\"Storyteller Cinema | âŒ PIXI Sprite Crash suppressed:\", pixiError);\r\n            // Se falhar aqui, nÃ£o hÃ¡ o que fazer alÃ©m de nÃ£o mostrar o sprite\r\n            return;\r\n        }\r\n\r\n        this.sprite.anchor.set(0.5, 1);\r\n        this.container.addChild(this.sprite);\r\n\r\n        // Z-Index Sorting\r\n        // Adiciona e ordena imediatamente para evitar delay visual\r\n        canvas.tokens.addChild(this.container);\r\n        canvas.tokens.sortChildren();\r\n\r\n        console.log(`Storyteller Cinema | âœ… Proxy Created for ${this.token.name}`);\r\n\r\n        this._initialized = true;\r\n        this.refresh();\r\n    }\r\n\r\n    /**\r\n     * Atualiza posiÃ§Ã£o e escala do Proxy baseado no Token Controller\r\n     */\r\n    refresh() {\r\n        if (!this._initialized || !this.token) return;\r\n\r\n        // Sincroniza PosiÃ§Ã£o (Centro-Baixo do grid)\r\n        const tokenCenter = this.token.center;\r\n        const halfHeight = (this.token.h * this.token.document.texture.scaleY) / 2;\r\n\r\n        this.container.position.set(tokenCenter.x, tokenCenter.y + halfHeight);\r\n\r\n        // Z-Index (Sortable)\r\n        // Sincroniza com o zIndex do token para que fique na mesma \"camada\" visual\r\n        if (this.token.mesh) {\r\n            this.container.zIndex = this.token.mesh.zIndex + 1;\r\n        }\r\n\r\n        // Garante visibilidade\r\n        this.container.visible = true;\r\n        this.container.alpha = 1;\r\n\r\n        // Aplica Efeitos Visuais (Standee 2.5D)\r\n        this._applyStandeeEffect();\r\n    }\r\n\r\n    _applyStandeeEffect() {\r\n        if (!this.texture || !this.texture.valid) return; // SeguranÃ§a extra\r\n\r\n        // 1. Escala por Profundidade\r\n        const sceneHeight = canvas.dimensions.height;\r\n        const yRatio = Math.max(0, Math.min(1, this.token.y / sceneHeight));\r\n\r\n        // InterpolaÃ§Ã£o Linear (Lerp)\r\n        const depthScale = this.settings.minDepth +\r\n            (yRatio * (this.settings.maxDepth - this.settings.minDepth));\r\n\r\n        // NormalizaÃ§Ã£o pela Altura de ReferÃªncia\r\n        const targetHeightPx = sceneHeight * this.settings.refHeight;\r\n\r\n        // Evita divisÃ£o por zero\r\n        const texHeight = this.texture.height || 100;\r\n        const baseScale = targetHeightPx / texHeight;\r\n\r\n        const finalScale = baseScale * depthScale;\r\n\r\n        // 2. RotaÃ§Ã£o e Flip (Standee)\r\n        this.container.rotation = 0;\r\n\r\n        // Detecta direÃ§Ã£o do Token para Flip\r\n        const rot = this.token.document.rotation;\r\n        const isLookingLeft = rot > 90 && rot < 270;\r\n\r\n        const scaleX = isLookingLeft ? -Math.abs(finalScale) : Math.abs(finalScale);\r\n\r\n        this.sprite.scale.set(scaleX, Math.abs(finalScale));\r\n    }\r\n\r\n    destroy() {\r\n        if (this.container && !this.container.destroyed) {\r\n            this.container.destroy({ children: true });\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Gerenciador Singleton dos Proxies\r\n */\r\nexport class ProxyManager {\r\n    static proxies = new Map();\r\n\r\n    static enable() {\r\n        console.log(\"Storyteller Cinema | ðŸŽ­ Spawning Proxies...\");\r\n\r\n        // Oculta Tokens Reais e Cria Proxies\r\n        canvas.tokens.placeables.forEach(token => {\r\n            if (!token.actor) return;\r\n\r\n            // Salva estado original de visibilidade se necessÃ¡rio, ou apenas forÃ§amos.\r\n            if (token.mesh) token.mesh.alpha = 0;\r\n\r\n            // Cria Proxy\r\n            if (!this.proxies.has(token.id)) {\r\n                this.proxies.set(token.id, new CinematicProxy(token));\r\n            }\r\n        });\r\n    }\r\n\r\n    static disable() {\r\n        console.log(\"Storyteller Cinema | ðŸŽ­ Destroying Proxies...\");\r\n\r\n        // Restaura Tokens Reais e DestrÃ³i Proxies\r\n        // Importante checar document.alpha para nÃ£o mostrar token escondido pelo GM\r\n        canvas.tokens.placeables.forEach(token => {\r\n            if (token.mesh) token.mesh.alpha = token.document.hidden ? 0.5 : 1;\r\n        });\r\n\r\n        this.proxies.forEach(proxy => proxy.destroy());\r\n        this.proxies.clear();\r\n    }\r\n\r\n    static update(token) {\r\n        // Chamado no hook updateToken/refreshToken\r\n        const proxy = this.proxies.get(token.id);\r\n        if (proxy) proxy.refresh();\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}