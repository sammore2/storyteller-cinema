{"version":3,"file":"skin-manager.js","sources":["../../src/scripts/core/skin-manager.js"],"sourcesContent":["export class SkinManager {\r\n    constructor() {\r\n        this.skins = new Map();\r\n        this.activeSkin = 'default';\r\n        this._styleTag = null;\r\n    }\r\n\r\n    init() {\r\n        console.log(\"Storyteller Cinema | Initializing Skin Manager...\");\r\n        this._createStyleTag();\r\n        this._registerDefaultSkins();\r\n        this._loadCustomSkins(); // <--- FIX: Load saved skins\r\n\r\n        // Load saved skin setting\r\n        const savedSkin = game.settings.get('storyteller-cinema', 'activeSkin') || 'default';\r\n        this.apply(savedSkin);\r\n    }\r\n\r\n    /**\r\n     * Registers a new skin definition\r\n     * @param {Object} skinData The skin definition object\r\n     * @param {boolean} persist Whether to save to database (default: false)\r\n     */\r\n    async register(skinData, persist = false) {\r\n        if (!skinData.id) {\r\n            console.error(\"Storyteller Cinema | Skin missing ID:\", skinData);\r\n            return;\r\n        }\r\n\r\n        // If checking out existing, merge to ensure refs don't break, or just overwrite.\r\n        // Overwrite is safer for full updates.\r\n        this.skins.set(skinData.id, skinData);\r\n\r\n        console.log(`Storyteller Cinema | Skin Registered: ${skinData.name} (${skinData.id})`);\r\n\r\n        if (persist) {\r\n            await this._saveCustomSkin(skinData);\r\n        }\r\n\r\n        // Notify UI to re-render names\r\n        Hooks.call('storyteller-cinema-skins-updated');\r\n    }\r\n\r\n    /**\r\n     * Loads custom skins from settings\r\n     */\r\n    _loadCustomSkins() {\r\n        const customSkins = game.settings.get('storyteller-cinema', 'customSkins') || [];\r\n        customSkins.forEach(skin => {\r\n            this.register(skin, false); // No need to re-save\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Saves a skin to the customSkins setting\r\n     */\r\n    async _saveCustomSkin(skinData) {\r\n        // Validation: Don't save default/system skins\r\n        if (skinData.author === 'System' || !skinData.id) return;\r\n\r\n        const customSkins = game.settings.get('storyteller-cinema', 'customSkins') || [];\r\n\r\n        // Remove existing version of this skin if any\r\n        const others = customSkins.filter(s => s.id !== skinData.id);\r\n\r\n        // Add new version\r\n        others.push(skinData);\r\n\r\n        await game.settings.set('storyteller-cinema', 'customSkins', others);\r\n        console.log(\"Storyteller Cinema | Custom Skins Saved to DB.\");\r\n        Hooks.call('storyteller-cinema-skins-updated');\r\n    }\r\n\r\n    /**\r\n     * Applies a skin by ID\r\n     * @param {string} skinId \r\n     */\r\n    async apply(skinId) {\r\n        if (!this.skins.has(skinId)) {\r\n            // Wait a moment in case styles haven't populated? No, logical fallback.\r\n            console.warn(`Storyteller Cinema | Skin '${skinId}' not found. Reverting to default.`);\r\n            skinId = 'default';\r\n        }\r\n\r\n        const skin = this.skins.get(skinId);\r\n        this.activeSkin = skinId;\r\n\r\n        // 1. Update Body Class\r\n        // Remove old skin classes\r\n        const classes = document.body.className.split(\" \").filter(c => !c.startsWith(\"cinematic-skin-\"));\r\n        document.body.className = classes.join(\" \");\r\n        // Add new class\r\n        document.body.classList.add(`cinematic-skin-${skinId}`);\r\n        document.body.dataset.cinematicSkin = skinId;\r\n\r\n        // 2. Inject CSS Variables\r\n        this._injectCSS(skin);\r\n\r\n        // 3. Save Setting\r\n        if (game.settings.get('storyteller-cinema', 'activeSkin') !== skinId) {\r\n            await game.settings.set('storyteller-cinema', 'activeSkin', skinId);\r\n        }\r\n\r\n        console.log(`Storyteller Cinema | Applied Skin: ${skin.name}`);\r\n    }\r\n\r\n    getSkins() {\r\n        return Array.from(this.skins.values());\r\n    }\r\n\r\n    /**\r\n     * Exports a skin to a JSON file\r\n     * @param {string} skinId \r\n     */\r\n    exportSkin(skinId) {\r\n        const skin = this.skins.get(skinId);\r\n        if (!skin) {\r\n            ui.notifications.error(\"Storyteller Cinema | Skin not found.\");\r\n            return;\r\n        }\r\n\r\n        const data = JSON.stringify(skin, null, 2);\r\n        const blob = new Blob([data], { type: 'application/json' });\r\n        const a = document.createElement('a');\r\n        a.href = URL.createObjectURL(blob);\r\n        a.download = `${skin.id}.json`;\r\n        a.click();\r\n    }\r\n    /**\r\n     * Imports a skin from a JSON string or object\r\n     * @param {string|object} jsonData \r\n     */\r\n    async importSkin(jsonData) {\r\n        let skin;\r\n        try {\r\n            skin = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;\r\n        } catch (e) {\r\n            ui.notifications.error(\"Storyteller Cinema | Invalid JSON.\");\r\n            return;\r\n        }\r\n\r\n        if (!skin.id || !skin.name) {\r\n            ui.notifications.error(\"Storyteller Cinema | Invalid Skin definition.\");\r\n            return;\r\n        }\r\n\r\n        // --- FUTURE AUTO-DOWNLOAD LOGIC HERE ---\r\n        if (skin.autoDownload) {\r\n            ui.notifications.info(\"Storyteller Cinema | Premium Skin detected. (Auto-Download coming in Phase 3)\");\r\n        }\r\n        // ---------------------------------------\r\n\r\n        // Register and Save to DB\r\n        await this.register(skin, true);\r\n        await this.apply(skin.id);\r\n\r\n        ui.notifications.info(`Storyteller Cinema | Imported skin: ${skin.name}`);\r\n        return skin;\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* INTERNALS                                                              */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    async _ensureDirectory(path) {\r\n        const source = 'data';\r\n        const parts = path.split('/');\r\n        let currentPath = \"\";\r\n\r\n        for (const part of parts) {\r\n            currentPath = currentPath ? `${currentPath}/${part}` : part;\r\n            try {\r\n                // Check if exists\r\n                await FilePicker.browse(source, currentPath);\r\n            } catch (e) {\r\n                // If not, try to create\r\n                try {\r\n                    await FilePicker.createDirectory(source, currentPath);\r\n                    console.log(`Storyteller Cinema | Created directory: ${currentPath}`);\r\n                } catch (err) {\r\n                    // Ignore if it already exists (race condition) or if root modules/ folder is protected\r\n                    if (!err.message.includes(\"EEXIST\")) {\r\n                        console.warn(`Storyteller Cinema | Failed to create ${currentPath}`, err);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    async _downloadAndSave(url, targetDir, filename) {\r\n        try {\r\n            const response = await fetch(url);\r\n            if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n            const blob = await response.blob();\r\n            const file = new File([blob], filename, { type: blob.type });\r\n\r\n            const result = await FilePicker.upload('data', targetDir, file);\r\n            return result.path;\r\n        } catch (err) {\r\n            console.error(`Storyteller Cinema | Failed to fetch ${url}`, err);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    _createStyleTag() {\r\n        if (!document.getElementById('storyteller-cinema-skin-styles')) {\r\n            this._styleTag = document.createElement('style');\r\n            this._styleTag.id = 'storyteller-cinema-skin-styles';\r\n            document.head.appendChild(this._styleTag);\r\n        } else {\r\n            this._styleTag = document.getElementById('storyteller-cinema-skin-styles');\r\n        }\r\n    }\r\n\r\n    _injectCSS(skin) {\r\n        if (!this._styleTag) this._createStyleTag();\r\n\r\n        let css = `:root { \\n`;\r\n\r\n        // Styles\r\n        if (skin.options.styles) {\r\n            for (const [key, value] of Object.entries(skin.options.styles)) {\r\n                css += `    ${key}: ${value};\\n`;\r\n            }\r\n        }\r\n\r\n        // Filters (Global)\r\n        if (skin.options.filter) {\r\n            css += `    --cinematic-filter: ${skin.options.filter};\\n`;\r\n        } else {\r\n            css += `    --cinematic-filter: none;\\n`;\r\n        }\r\n\r\n        // Backgrounds\r\n        if (skin.options.backgroundTexture) {\r\n            css += `    --cinematic-bg-texture: url('${skin.options.backgroundTexture}');\\n`;\r\n        } else {\r\n            css += `    --cinematic-bg-texture: none;\\n`;\r\n        }\r\n\r\n        css += `}\\n`;\r\n\r\n        // Apply Filter specifically to the scene container or body if needed\r\n        // Assuming style.scss uses var(--cinematic-filter)\r\n\r\n        this._styleTag.innerHTML = css;\r\n    }\r\n\r\n    _registerDefaultSkins() {\r\n        // 1. DEFAULT\r\n        this.register({\r\n            id: 'default',\r\n            name: 'Classic Black',\r\n            author: 'Storyteller',\r\n            version: '1.0.0',\r\n            options: {\r\n                theme: 'dark',\r\n                styles: {\r\n                    '--cinematic-bar-bg': '#000000',\r\n                    '--cinematic-bar-border': 'none',\r\n                    '--cinematic-text-color': '#ffffff'\r\n                }\r\n            }\r\n        });\r\n\r\n        // 2. VIGNETTE\r\n        this.register({\r\n            id: 'vignette',\r\n            name: 'Soft Vignette',\r\n            author: 'Storyteller',\r\n            version: '1.0.0',\r\n            options: {\r\n                theme: 'dark',\r\n                styles: {\r\n                    '--cinematic-bar-bg': 'linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 50%, transparent 100%)',\r\n                    '--cinematic-bar-border': 'none',\r\n                    '--cinematic-text-color': '#e0e0e0'\r\n                }\r\n            }\r\n        });\r\n\r\n        // 3. NOIR\r\n        this.register({\r\n            id: 'noir',\r\n            name: 'Noir Detective',\r\n            author: 'Storyteller',\r\n            version: '1.0.0',\r\n            options: {\r\n                theme: 'dark',\r\n                filter: 'grayscale(100%) contrast(1.2)',\r\n                styles: {\r\n                    '--cinematic-bar-bg': '#1a1a1a',\r\n                    '--cinematic-bar-border': '1px solid #333',\r\n                    '--cinematic-text-color': '#cccccc'\r\n                }\r\n            }\r\n        });\r\n\r\n        // 4. SEPIA\r\n        this.register({\r\n            id: 'sepia',\r\n            name: 'Old Photograph',\r\n            author: 'Storyteller',\r\n            version: '1.0.0',\r\n            options: {\r\n                theme: 'light',\r\n                filter: 'sepia(0.8) contrast(0.9)',\r\n                styles: {\r\n                    '--cinematic-bar-bg': '#3b2f2f',\r\n                    '--cinematic-bar-border': '2px solid #8b7355',\r\n                    '--cinematic-text-color': '#f4ebd0'\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}