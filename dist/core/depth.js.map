{"version":3,"file":"depth.js","sources":["../../src/scripts/core/depth.js"],"sourcesContent":["/**\r\n * Aplica escala visual híbrida (Auto Viewport + Manual Config + Quick Zoom).\r\n */\r\nexport function applyVisualDepth(token) {\r\n  if (!token.mesh || !token.scene) return;\r\n\r\n  // --- 1. Math: Viewport Target (Auto Scale) ---\r\n  const screenHeight = canvas.app.renderer.screen.height;\r\n  const refHeightPercent = game.settings.get('storyteller-cinema', 'referenceHeight') || 30;\r\n\r\n  // Altura alvo na tela em pixels\r\n  const targetPx = screenHeight * (refHeightPercent / 100);\r\n\r\n  // Altura da textura original\r\n  const texHeight = token.document.texture.src ? (token.texture?.height || 100) : 100;\r\n\r\n  // Escala automática para atingir o targetPx\r\n  const autoScale = targetPx / texHeight;\r\n\r\n  // --- 2. Manual Adjustments (User Control) ---\r\n\r\n  // Grid Size: Tokens grandes (2x2) devem ser maiores\r\n  const gridSizeMult = Math.max(token.document.width, token.document.height);\r\n\r\n  // Manual Scale: Respeita o slider \"Scale\" da ficha do token (Ajuste Permanente)\r\n  const docScaleX = token.document.texture.scaleX;\r\n  const manualTweak = Math.abs(docScaleX) || 1;\r\n\r\n  // --- NOVO: Cinematic Scale (Shift + Scroll - Ajuste Temporário/Rápido) ---\r\n  // Prioriza o preview local (instantâneo) sobre o dado do banco (lento)\r\n  const quickZoom = token._cinemaScalePreview ?? token.document.getFlag('storyteller-cinema', 'cinematicScale') ?? 1.0;\r\n\r\n  // Combina todos os multiplicadores manuais\r\n  const manualMultiplier = gridSizeMult * manualTweak * quickZoom;\r\n\r\n  // --- 3. Depth Factor (Parallax) ---\r\n  const sceneHeight = token.scene.dimensions.height;\r\n  let ratio = token.y / sceneHeight;\r\n  ratio = Math.max(0, Math.min(1, ratio));\r\n\r\n  const minDepth = game.settings.get('storyteller-cinema', 'minScale') || 0.5;\r\n  const maxDepth = game.settings.get('storyteller-cinema', 'maxScale') || 1.0;\r\n\r\n  const depthFactor = minDepth + (ratio * (maxDepth - minDepth));\r\n\r\n  // --- 4. Final Calculation ---\r\n  // Agora inclui o quickZoom na conta!\r\n  const finalScale = autoScale * manualMultiplier * depthFactor;\r\n\r\n  // --- 5. Application with Flip Preservation ---\r\n  if (Number.isFinite(finalScale)) {\r\n    // Detecta Flip Horizontal do Documento\r\n    const sign = Math.sign(docScaleX) || 1;\r\n\r\n    token.mesh.scale.set(finalScale * sign, finalScale);\r\n\r\n    // Trava Rotação Visual (Sempre em pé)\r\n    token.mesh.rotation = 0;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAGO,SAAS,iBAAiB,OAAO;AAHxC;AAIE,MAAI,CAAC,MAAM,QAAQ,CAAC,MAAM,MAAO;AAGjC,QAAM,eAAe,OAAO,IAAI,SAAS,OAAO;AAChD,QAAM,mBAAmB,KAAK,SAAS,IAAI,sBAAsB,iBAAiB,KAAK;AAGvF,QAAM,WAAW,gBAAgB,mBAAmB;AAGpD,QAAM,YAAY,MAAM,SAAS,QAAQ,QAAO,WAAM,YAAN,mBAAe,WAAU,MAAO;AAGhF,QAAM,YAAY,WAAW;AAK7B,QAAM,eAAe,KAAK,IAAI,MAAM,SAAS,OAAO,MAAM,SAAS,MAAM;AAGzE,QAAM,YAAY,MAAM,SAAS,QAAQ;AACzC,QAAM,cAAc,KAAK,IAAI,SAAS,KAAK;AAI3C,QAAM,YAAY,MAAM,uBAAuB,MAAM,SAAS,QAAQ,sBAAsB,gBAAgB,KAAK;AAGjH,QAAM,mBAAmB,eAAe,cAAc;AAGtD,QAAM,cAAc,MAAM,MAAM,WAAW;AAC3C,MAAI,QAAQ,MAAM,IAAI;AACtB,UAAQ,KAAK,IAAI,GAAG,KAAK,IAAI,GAAG,KAAK,CAAC;AAEtC,QAAM,WAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,KAAK;AACxE,QAAM,WAAW,KAAK,SAAS,IAAI,sBAAsB,UAAU,KAAK;AAExE,QAAM,cAAc,WAAY,SAAS,WAAW;AAIpD,QAAM,aAAa,YAAY,mBAAmB;AAGlD,MAAI,OAAO,SAAS,UAAU,GAAG;AAE/B,UAAM,OAAO,KAAK,KAAK,SAAS,KAAK;AAErC,UAAM,KAAK,MAAM,IAAI,aAAa,MAAM,UAAU;AAGlD,UAAM,KAAK,WAAW;AAAA,EACxB;AACF;"}