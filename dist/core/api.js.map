{"version":3,"file":"api.js","sources":["../../src/scripts/core/api.js"],"sourcesContent":["import { applyVisualDepth } from './depth.js';\r\n\r\nexport class StorytellerAPI {\r\n    constructor() {\r\n        this.active = false;\r\n        this.cinematicContainer = null;\r\n\r\n        // Cache used for Vision Override\r\n        this._visionCache = new Map();\r\n        this._sceneLightCache = null;\r\n        this._visionOverrideActive = false;\r\n    }\r\n\r\n    /**\r\n     * Initializes the API (called from main.js)\r\n     */\r\n    init() {\r\n        console.log(\"Storyteller Cinema | API Initialized\");\r\n        this._createOverlay();\r\n        // Register itself independently if needed, but main.js will attach it to window\r\n    }\r\n\r\n    /**\r\n     * Main Entry Point for Toggling Mode\r\n     * @param {boolean} active \r\n     * @param {object} options { skin: 'default', init: boolean }\r\n     */\r\n    async toggle(active, options = {}) {\r\n        const overlay = document.getElementById('storyteller-cinema-overlay');\r\n        const skin = options.skin || 'default';\r\n        this.active = active;\r\n\r\n        // 1. Vision & Light Logic (The \"Disarmament\" Strategy)\r\n        if (active) {\r\n            await this._applyVisionOverride(true);\r\n        } else {\r\n            await this._applyVisionOverride(false);\r\n        }\r\n\r\n        if (active) {\r\n            // --- ACTIVATE ---\r\n            await this._setCinematicBackground(true);\r\n\r\n            // Save Battle View (Pivot/Scale)\r\n            if (canvas.ready) {\r\n                const battleView = {\r\n                    x: canvas.stage.pivot.x,\r\n                    y: canvas.stage.pivot.y,\r\n                    scale: canvas.stage.scale.x\r\n                };\r\n                canvas.storytellerBattleView = battleView;\r\n            }\r\n\r\n            // GM Actions\r\n            if (game.user.isGM) {\r\n                await this._ensureGhostMode(true);\r\n            }\r\n\r\n            // UI\r\n            if (overlay) overlay.classList.add('active');\r\n            document.body.classList.add('cinematic-mode');\r\n            if (skin) {\r\n                document.body.classList.add(`cinematic-skin-${skin}`);\r\n                document.body.dataset.cinematicSkin = skin;\r\n            }\r\n\r\n            // Camera Pan\r\n            await this._panCameraToFit(options.init);\r\n\r\n            // Token Hiding & Depth\r\n            await this._processTokens(true);\r\n\r\n        } else {\r\n            // --- DEACTIVATE ---\r\n            if (game.user.isGM) {\r\n                await this._ensureGhostMode(false, true);\r\n            }\r\n            await this._setCinematicBackground(false);\r\n\r\n            // UI\r\n            if (overlay) overlay.classList.remove('active');\r\n            document.body.classList.remove('cinematic-mode');\r\n\r\n            const skins = Array.from(document.body.classList).filter(c => c.startsWith('cinematic-skin-'));\r\n            skins.forEach(c => document.body.classList.remove(c));\r\n            delete document.body.dataset.cinematicSkin;\r\n\r\n            // Restore Camera\r\n            if (canvas.storytellerBattleView) {\r\n                const v = canvas.storytellerBattleView;\r\n                await canvas.animatePan({ x: v.x, y: v.y, scale: v.scale, duration: 800 });\r\n                canvas.storytellerBattleView = null;\r\n            }\r\n\r\n            // Restore Tokens\r\n            await this._processTokens(false);\r\n        }\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* LOGIC: VISION & LIGHTING (THE FIX)                                     */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    _applyVisionOverride(active) {\r\n        if (!canvas.ready || !canvas.scene) return;\r\n\r\n        // V13+ Compatibility: Environment Model\r\n        const environment = canvas.scene.environment; // V13\r\n        // Fallback for V11/12 if needed, though target is V13.\r\n        // We will write to the environment object in memory.\r\n\r\n        if (active) {\r\n            this._visionOverrideActive = true;\r\n\r\n            // 1. Force Global Light (Memory Only)\r\n            if (this._sceneLightCache === null) {\r\n                // Check V13 structure vs Legacy\r\n                if (environment && environment.globalLight) {\r\n                    this._sceneLightCache = environment.globalLight.enabled;\r\n                    // Modify memory (Not DB) - hope Foundry respects this for rendering\r\n                    environment.globalLight.enabled = true;\r\n                    environment.globalLight.source = true; // Ensure logic sees it as valid source\r\n                } else {\r\n                    // Legacy Fallback\r\n                    this._sceneLightCache = canvas.scene.globalLight;\r\n                    canvas.scene.globalLight = true;\r\n                }\r\n            }\r\n\r\n        } else {\r\n            this._visionOverrideActive = false;\r\n\r\n            // Restore Light\r\n            if (this._sceneLightCache !== null) {\r\n                if (environment && environment.globalLight) {\r\n                    environment.globalLight.enabled = this._sceneLightCache;\r\n                } else {\r\n                    canvas.scene.globalLight = this._sceneLightCache;\r\n                }\r\n                this._sceneLightCache = null;\r\n            }\r\n        }\r\n\r\n        // Commit Updates (Triggers the libWrapper check)\r\n        canvas.perception.update({\r\n            refreshVision: true,\r\n            refreshLighting: true\r\n        }, true);\r\n    }\r\n\r\n    // Called by Hook to enforce state after scene refresh\r\n    enforceVision() {\r\n        if (this._visionOverrideActive) {\r\n            this._applyVisionOverride(true);\r\n        }\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* LOGIC: BACKGROUND                                                      */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    async _setCinematicBackground(active) {\r\n        if (active) {\r\n            const bgPath = canvas.scene.getFlag('storyteller-cinema', 'cinematicBg');\r\n\r\n            // Hiding Clutter\r\n            this._toggleLayerVisibility(false);\r\n\r\n            if (bgPath) {\r\n                try {\r\n                    const tex = await foundry.canvas.loadTexture(bgPath);\r\n                    if (!this.cinematicContainer || this.cinematicContainer.destroyed) {\r\n                        this.cinematicContainer = new PIXI.Container();\r\n                        this.cinematicContainer.eventMode = 'none';\r\n                        const sprite = new PIXI.Sprite(tex);\r\n                        sprite.anchor.set(0.5);\r\n                        this.cinematicContainer.addChild(sprite);\r\n                        canvas.primary.addChildAt(this.cinematicContainer, 0);\r\n                    } else {\r\n                        // Ensure it's in the scene\r\n                        if (this.cinematicContainer.parent !== canvas.primary) {\r\n                            canvas.primary.addChildAt(this.cinematicContainer, 0);\r\n                        }\r\n                    }\r\n\r\n                    const sprite = this.cinematicContainer.children[0];\r\n                    sprite.texture = tex;\r\n\r\n                    // Fit Logic\r\n                    this._fitSpriteToScreen(sprite, tex);\r\n\r\n                } catch (err) {\r\n                    console.error(\"Storyteller Cinema | BG Error:\", err);\r\n                }\r\n            }\r\n\r\n        } else {\r\n            this._toggleLayerVisibility(true);\r\n\r\n            if (this.cinematicContainer) {\r\n                this.cinematicContainer.destroy({ children: true, texture: false });\r\n                this.cinematicContainer = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    _fitSpriteToScreen(sprite, tex) {\r\n        const rect = canvas.dimensions.sceneRect;\r\n        const scaleW = window.innerWidth / rect.width;\r\n        const scaleH = window.innerHeight / rect.height;\r\n        const cameraScale = Math.min(scaleW, scaleH); // Mimic camera zoom\r\n\r\n        const visibleWorldW = window.innerWidth / cameraScale;\r\n        const visibleWorldH = window.innerHeight / cameraScale;\r\n\r\n        const cx = rect.x + rect.width / 2;\r\n        const cy = rect.y + rect.height / 2;\r\n        sprite.position.set(cx, cy);\r\n\r\n        const targetW = Math.max(rect.width, visibleWorldW);\r\n        const targetH = Math.max(rect.height, visibleWorldH);\r\n\r\n        const sX = targetW / tex.width;\r\n        const sY = targetH / tex.height;\r\n        sprite.scale.set(Math.max(sX, sY));\r\n    }\r\n\r\n    _toggleLayerVisibility(visible) {\r\n        if (canvas.primary?.background) canvas.primary.background.visible = visible;\r\n        if (canvas.grid) canvas.grid.visible = visible;\r\n        if (canvas.walls) canvas.walls.visible = visible;\r\n        if (canvas.templates) canvas.templates.visible = visible;\r\n        if (canvas.foreground) canvas.foreground.visible = visible;\r\n        if (canvas.controls?.doors) canvas.controls.doors.visible = visible;\r\n        if (canvas.lighting) canvas.lighting.visible = visible;\r\n        if (canvas.effects) canvas.effects.visible = visible;\r\n        if (canvas.fog) canvas.fog.visible = visible;\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* LOGIC: CAMERA                                                          */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    async _panCameraToFit(isInit) {\r\n        const rect = canvas.dimensions.sceneRect;\r\n        const scaleW = window.innerWidth / rect.width;\r\n        const scaleH = window.innerHeight / rect.height;\r\n        let targetScale = Math.max(scaleW, scaleH);\r\n\r\n        const minZ = canvas.minScale || 0.1;\r\n        const maxZ = canvas.maxScale || 3.0;\r\n        targetScale = Math.max(minZ, Math.min(maxZ, targetScale));\r\n\r\n        const cx = rect.x + rect.width / 2;\r\n        const cy = rect.y + rect.height / 2;\r\n\r\n        if (!isInit) {\r\n            await canvas.animatePan({ x: cx, y: cy, scale: targetScale, duration: 800 });\r\n        } else {\r\n            canvas.stage.pivot.set(cx, cy);\r\n            canvas.stage.scale.set(targetScale);\r\n        }\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* LOGIC: TOKENS                                                          */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    async _processTokens(active) {\r\n        if (!canvas.tokens) return;\r\n\r\n        for (const token of canvas.tokens.placeables) {\r\n            if (active) {\r\n                // Battle Save (GM)\r\n                const existingBattlePos = token.document.getFlag('storyteller-cinema', 'battlePos');\r\n                if (game.user.isGM && !existingBattlePos) {\r\n                    await token.document.setFlag('storyteller-cinema', 'battlePos', { x: token.document.x, y: token.document.y });\r\n                }\r\n\r\n                // Hide Mesh temporarily\r\n                if (token.mesh) token.mesh.alpha = 0;\r\n\r\n                // Move to Cinematic Pos if exists\r\n                const cinPos = token.document.getFlag('storyteller-cinema', 'cinematicPos');\r\n                const updates = {};\r\n                if (cinPos) { updates.x = cinPos.x; updates.y = cinPos.y; }\r\n\r\n                // Swap Texture (GM)\r\n                if (game.user.isGM) {\r\n                    const cinTex = token.document.getFlag('storyteller-cinema', 'cinematicTexture');\r\n                    if (cinTex) {\r\n                        const orig = token.document.getFlag('storyteller-cinema', 'originalTexture');\r\n                        if (!orig) await token.document.setFlag('storyteller-cinema', 'originalTexture', token.document.texture.src);\r\n                        updates[\"texture.src\"] = cinTex;\r\n                    }\r\n                    if (Object.keys(updates).length > 0) await this._silentTeleport(token, updates);\r\n                }\r\n\r\n                applyVisualDepth(token); // Apply Parallax\r\n\r\n                // Reveal\r\n                if (token.mesh) {\r\n                    const CanvasAnimation = foundry.canvas.animation.CanvasAnimation;\r\n                    CanvasAnimation.animate([{ parent: token.mesh, attribute: \"alpha\", to: 1 }], { duration: 400, name: `FadeIn-${token.id}` });\r\n                }\r\n\r\n            } else {\r\n                // Deactivate\r\n                if (token.document) {\r\n                    if (game.user.isGM) {\r\n                        await token.document.setFlag('storyteller-cinema', 'cinematicPos', { x: token.document.x, y: token.document.y });\r\n                    }\r\n\r\n                    if (token.mesh) token.mesh.alpha = 0;\r\n\r\n                    const updates = {};\r\n                    if (game.user.isGM) {\r\n                        const orig = token.document.getFlag('storyteller-cinema', 'originalTexture');\r\n                        if (orig) {\r\n                            updates[\"texture.src\"] = orig;\r\n                            await token.document.unsetFlag('storyteller-cinema', 'originalTexture');\r\n                        }\r\n                        const bPos = token.document.getFlag('storyteller-cinema', 'battlePos');\r\n                        if (bPos) { updates.x = bPos.x; updates.y = bPos.y; }\r\n\r\n                        if (Object.keys(updates).length > 0) await this._silentTeleport(token, updates);\r\n                    }\r\n\r\n                    if (token.mesh) {\r\n                        token.mesh.scale.set(token.document.texture.scaleX, token.document.texture.scaleY);\r\n                        const targetAlpha = token.document.hidden ? 0.5 : 1;\r\n                        const CanvasAnimation = foundry.canvas.animation.CanvasAnimation;\r\n                        CanvasAnimation.animate([{ parent: token.mesh, attribute: \"alpha\", to: targetAlpha }], { duration: 400, name: `FadeOut-${token.id}` });\r\n                        token.refresh();\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    async _silentTeleport(token, pos) {\r\n        // Suppress V13 Deprecation Warning logic\r\n        const originalWarn = console.warn;\r\n        const originalError = console.error;\r\n        const isPolluted = (...args) => args.some(a => (a?.toString() || '').includes('DatabaseUpdateOperation#teleport'));\r\n\r\n        console.warn = (...args) => { if (!isPolluted(...args)) originalWarn.apply(console, args); };\r\n        console.error = (...args) => { if (!isPolluted(...args)) originalError.apply(console, args); };\r\n\r\n        try {\r\n            await token.document.update(pos, { animate: false, animation: { duration: 0 }, teleport: true, skippingMemory: true });\r\n        } catch (e) {\r\n            originalError.apply(console, [\"Teleport Error\", e]);\r\n        } finally {\r\n            console.warn = originalWarn;\r\n            console.error = originalError;\r\n        }\r\n    }\r\n\r\n    _ensureGhostMode(target, force = false) {\r\n        const current = game.settings.get(\"core\", \"unconstrainedMovement\");\r\n        if (current === target && !force) return;\r\n        game.settings.set(\"core\", \"unconstrainedMovement\", target).catch(() => { });\r\n    }\r\n\r\n    _createOverlay() {\r\n        if (document.getElementById('storyteller-cinema-overlay')) return;\r\n        const overlay = document.createElement('div');\r\n        overlay.id = 'storyteller-cinema-overlay';\r\n        overlay.innerHTML = '<div class=\"cinematic-bar top\"></div><div class=\"cinematic-bar bottom\"></div>';\r\n        document.body.appendChild(overlay);\r\n    }\r\n}\r\n"],"names":["sprite"],"mappings":"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"}