{"version":3,"file":"cinematic.js","sources":["../../src/scripts/core/cinematic.js"],"sourcesContent":["import { applyVisualDepth } from './depth.js';\r\n\r\nexport function createOverlay() {\r\n    if (document.getElementById('storyteller-cinema-overlay')) return;\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'storyteller-cinema-overlay';\r\n    overlay.innerHTML = '<div class=\"cinematic-bar top\"></div><div class=\"cinematic-bar bottom\"></div>';\r\n    document.body.appendChild(overlay);\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// HELPER: Wait for Ghost Mode \r\n// -----------------------------------------------------------------------------\r\nasync function ensureGhostMode(targetState, force = false) {\r\n    const currentState = game.settings.get(\"core\", \"unconstrainedMovement\");\r\n    if (currentState === targetState && !force) return;\r\n    try {\r\n        await game.settings.set(\"core\", \"unconstrainedMovement\", targetState);\r\n        await new Promise(r => setTimeout(r, 300));\r\n    } catch (e) {\r\n        // Ignore setting errors\r\n    }\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// HELPER: Silent Teleport (Aggressively Suppresses V13 Deprecation Warning)\r\n// -----------------------------------------------------------------------------\r\nasync function silentTeleport(token, pos) {\r\n    // CAPTURE ORIGINAL METHODS\r\n    const originalWarn = console.warn;\r\n    const originalError = console.error; // Sometimes deprecations log as errors\r\n\r\n    // DEFINING THE FILTER\r\n    // We filter any message that mentions the specific deprecated field.\r\n    const isPolluted = (...args) => {\r\n        const msg = args.map(a => {\r\n            if (a instanceof Error) return a.message;\r\n            return a?.toString() || '';\r\n        }).join(' ');\r\n        return msg.includes('DatabaseUpdateOperation#teleport');\r\n    };\r\n\r\n    // APPLY PATCHES\r\n    console.warn = function (...args) {\r\n        if (isPolluted(...args)) return;\r\n        originalWarn.apply(console, args);\r\n    };\r\n    console.error = function (...args) {\r\n        if (isPolluted(...args)) return;\r\n        originalError.apply(console, args);\r\n    };\r\n\r\n    try {\r\n        // EXECUTE TELEPORT\r\n        // 'teleport: true' is indeed the functionality we want.\r\n        await token.document.update({ x: pos.x, y: pos.y }, {\r\n            animate: false,\r\n            animation: { duration: 0 },\r\n            teleport: true,\r\n            skippingMemory: true\r\n        });\r\n    } catch (err) {\r\n        // Allow genuine errors\r\n        originalError.apply(console, [\"Storyteller Cinema | Teleport Error:\", err]);\r\n    } finally {\r\n        // RESTORE CONSOLE\r\n        console.warn = originalWarn;\r\n        console.error = originalError;\r\n    }\r\n}\r\n\r\n\r\nexport async function toggleCinematicMode(active, options = {}) {\r\n    console.log(\"Storyteller Cinema | Toggle Called. Target:\", active);\r\n    const overlay = document.getElementById('storyteller-cinema-overlay');\r\n\r\n    if (active) {\r\n        // --- 1. ATIVAR ---\r\n        await ensureGhostMode(true);\r\n\r\n        if (overlay) overlay.classList.add('active');\r\n        document.body.classList.add('cinematic-mode');\r\n\r\n        if (canvas.tokens) {\r\n            for (const token of canvas.tokens.placeables) {\r\n                // Read-Only Battle Save\r\n                const existingBattlePos = token.document.getFlag('storyteller-cinema', 'battlePos');\r\n                if (!existingBattlePos) {\r\n                    const currentPos = { x: token.document.x, y: token.document.y };\r\n                    await token.document.setFlag('storyteller-cinema', 'battlePos', currentPos);\r\n                }\r\n\r\n                // Teleport\r\n                const cinPos = token.document.getFlag('storyteller-cinema', 'cinematicPos');\r\n                if (cinPos) {\r\n                    await silentTeleport(token, cinPos);\r\n                }\r\n                applyVisualDepth(token);\r\n            }\r\n        }\r\n\r\n    } else {\r\n        // --- 2. DESATIVAR ---\r\n\r\n        await ensureGhostMode(true, true);\r\n\r\n        if (overlay) overlay.classList.remove('active');\r\n        document.body.classList.remove('cinematic-mode');\r\n\r\n        if (canvas.tokens) {\r\n            for (const token of canvas.tokens.placeables) {\r\n                if (token.document) {\r\n                    const currentPos = { x: token.document.x, y: token.document.y };\r\n                    await token.document.setFlag('storyteller-cinema', 'cinematicPos', currentPos);\r\n\r\n                    const battlePos = token.document.getFlag('storyteller-cinema', 'battlePos');\r\n\r\n                    if (token.mesh) {\r\n                        token.mesh.scale.set(token.document.texture.scaleX, token.document.texture.scaleY);\r\n                        token.mesh.alpha = token.document.hidden ? 0.5 : 1;\r\n                        token.refresh();\r\n                    }\r\n\r\n                    if (battlePos) {\r\n                        await silentTeleport(token, battlePos);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        await new Promise(r => setTimeout(r, 500));\r\n        await ensureGhostMode(false);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}