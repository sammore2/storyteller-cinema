{"version":3,"file":"cinematic.js","sources":["../../src/scripts/core/cinematic.js"],"sourcesContent":["import { applyVisualDepth } from './depth.js';\r\n\r\nexport function createOverlay() {\r\n    if (document.getElementById('storyteller-cinema-overlay')) return;\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'storyteller-cinema-overlay';\r\n    overlay.innerHTML = '<div class=\"cinematic-bar top\"></div><div class=\"cinematic-bar bottom\"></div>';\r\n    document.body.appendChild(overlay);\r\n}\r\n\r\n// Helper to toggle the Ghost/Noclip tool safely\r\nasync function setGhostMode(active) {\r\n    let toolFound = false;\r\n\r\n    // FIND THE DOM BUTTON FIRST (Visual Truth)\r\n    const allPossibleButtons = Array.from(document.querySelectorAll('.control-tool, button, .fas.fa-ghost'));\r\n    const ghostBtn = allPossibleButtons.find(el => {\r\n        const target = el.tagName === 'I' ? el.closest('li, button') : el;\r\n        if (!target) return false;\r\n        const textToCheck = ((target.dataset.tooltip || \"\") + (target.title || \"\") + (target.getAttribute('aria-label') || \"\")).toLowerCase();\r\n        return target.dataset.tool === 'noclip' || target.querySelector('.fa-ghost') || textToCheck.includes('irrestrito') || textToCheck.includes('unrestricted') || textToCheck.includes('ghost');\r\n    });\r\n\r\n    // DETERMINE CURRENT STATE FROM DOM\r\n    let isVisuallyActive = false;\r\n    let clickTarget = null;\r\n    if (ghostBtn) {\r\n        clickTarget = ghostBtn.tagName === 'I' ? ghostBtn.closest('li, button') : ghostBtn;\r\n        if (clickTarget) {\r\n            isVisuallyActive = clickTarget.classList.contains('active');\r\n        }\r\n    }\r\n\r\n    console.log(\"Storyteller Cinema | Ghost Mode Target:\", active, \"| Visual State:\", isVisuallyActive);\r\n\r\n    // IF STATES MATCH, DO NOTHING\r\n    if (isVisuallyActive === active) {\r\n        console.log(\"Storyteller Cinema | Ghost Mode already in target state.\");\r\n        return;\r\n    }\r\n\r\n    // --- 1. API ATTEMPT (Preferred for clicking) ---\r\n    try {\r\n        if (ui.controls && ui.controls.controls) {\r\n            const controlList = Array.isArray(ui.controls.controls) ? ui.controls.controls : Object.values(ui.controls.controls);\r\n            const tokenLayer = controlList.find(c => c.name === \"token\" || c.name === \"tokens\");\r\n\r\n            if (tokenLayer && tokenLayer.tools) {\r\n                const toolsList = Array.isArray(tokenLayer.tools) ? tokenLayer.tools : Object.values(tokenLayer.tools);\r\n                const noclipTool = toolsList.find(t =>\r\n                    ['noclip', 'bypass', 'ghost', 'unrestricted'].includes(t.name) ||\r\n                    (t.icon && t.icon.includes('fa-ghost')) ||\r\n                    (t.title && (t.title.toLowerCase().includes('irrestrito') || t.title.toLowerCase().includes('unrestricted')))\r\n                );\r\n\r\n                if (noclipTool) {\r\n                    console.log(\"Storyteller Cinema | API Tool Found:\", noclipTool.name);\r\n                    if (typeof noclipTool.onClick === 'function') {\r\n                        noclipTool.onClick();\r\n                    } else {\r\n                        noclipTool.active = active;\r\n                    }\r\n\r\n                    // Force re-render to ensure visual update\r\n                    ui.controls.render();\r\n                    toolFound = true;\r\n                }\r\n            }\r\n        }\r\n    } catch (err) {\r\n        console.error(\"Storyteller Cinema | API Toggle Error:\", err);\r\n    }\r\n\r\n    // --- 2. DOM FALLBACK CLICK (If API didn't find tool) ---\r\n    if (!toolFound && clickTarget) {\r\n        console.log(\"Storyteller Cinema | Clicking Ghost Button via DOM\");\r\n        clickTarget.click();\r\n    }\r\n\r\n    // Tiny delay to allow Foundry physics engine to register the layer change\r\n    await new Promise(resolve => setTimeout(resolve, 50));\r\n}\r\n\r\nexport async function toggleCinematicMode(active) {\r\n    console.log(\"Storyteller Cinema | Toggle Called. Active:\", active);\r\n    const overlay = document.getElementById('storyteller-cinema-overlay');\r\n\r\n    if (active) {\r\n        // --- 1. ATIVAR (CINEMATIC ON) ---\r\n\r\n        // A. ENABLE GHOST MODE FIRST\r\n        await setGhostMode(true);\r\n\r\n        // B. Visuals\r\n        if (overlay) overlay.classList.add('active');\r\n        document.body.classList.add('cinematic-mode');\r\n        console.log(\"Storyteller Cinema | ðŸŸ¢ Visual Novel Mode ON\");\r\n\r\n        // C. DUAL POSITIONING: SAVE BATTLE POS -> TELEPORT TO CINEMATIC POS\r\n        if (canvas.tokens) {\r\n            const updates = [];\r\n            for (const token of canvas.tokens.placeables) {\r\n                await token.document.setFlag('storyteller-cinema', 'battlePos', { x: token.document.x, y: token.document.y });\r\n\r\n                const cinPos = token.document.getFlag('storyteller-cinema', 'cinematicPos');\r\n                if (cinPos) {\r\n                    await token.document.update({ x: cinPos.x, y: cinPos.y }, { animate: false });\r\n                }\r\n                applyVisualDepth(token);\r\n            }\r\n            // NÃ£o precisa de update em massa para o animate: false, mas se precisasse... \r\n            // O update acima Ã© individual e assÃ­ncrono.\r\n        }\r\n\r\n    } else {\r\n        // --- 2. DESATIVAR (CINEMATIC OFF) ---\r\n\r\n        // A. RESET VISIALS FIRST\r\n        if (overlay) overlay.classList.remove('active');\r\n        document.body.classList.remove('cinematic-mode');\r\n        console.log(\"Storyteller Cinema | ðŸ”´ Visual Novel Mode OFF\");\r\n\r\n        // B. DUAL POSITIONING: SAVE CINEMATIC POS -> TELEPORT BACK TO BATTLE POS\r\n        if (canvas.tokens) {\r\n            for (const token of canvas.tokens.placeables) {\r\n                if (token.document) {\r\n                    await token.document.setFlag('storyteller-cinema', 'cinematicPos', { x: token.document.x, y: token.document.y });\r\n\r\n                    const battlePos = token.document.getFlag('storyteller-cinema', 'battlePos');\r\n\r\n                    if (token.mesh) {\r\n                        token.mesh.scale.set(token.document.texture.scaleX, token.document.texture.scaleY);\r\n                        token.mesh.rotation = Math.toRadians(token.document.rotation);\r\n                        token.mesh.alpha = token.document.hidden ? 0.5 : 1;\r\n                        token.refresh();\r\n                    }\r\n\r\n                    if (battlePos) {\r\n                        await token.document.update({ x: battlePos.x, y: battlePos.y }, { animate: false });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // C. DISABLE GHOST MODE LAST\r\n        await setGhostMode(false);\r\n    }\r\n    console.log(\"Storyteller Cinema | Automation Check Complete\");\r\n}\r\n"],"names":[],"mappings":"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"}