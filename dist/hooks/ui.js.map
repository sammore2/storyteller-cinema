{"version":3,"file":"ui.js","sources":["../../src/components/ViewModeSelect.svelte","../../src/scripts/hooks/ui.js"],"sourcesContent":["<script>\r\n  export let scene;\r\n\r\n  // Inicializa o estado com o valor atual da flag ou padrﾃ｣o 'battlemap'\r\n  let viewMode = scene.getFlag(\"storyteller-cinema\", \"viewMode\") || \"battlemap\";\r\n\r\n  /**\r\n   * Atualiza a flag quando o valor do select muda.\r\n   */\r\n  async function updateViewMode(event) {\r\n    viewMode = event.target.value;\r\n    await scene.setFlag(\"storyteller-cinema\", \"viewMode\", viewMode);\r\n    console.log(`Storyteller Cinema | 汐 View Mode set to: ${viewMode}`);\r\n  }\r\n</script>\r\n\r\n<div class=\"form-group\">\r\n  <label for=\"viewModeSelect\">Visualizaﾃｧﾃ｣o Padrﾃ｣o</label>\r\n  <div class=\"form-fields\">\r\n    <select id=\"viewModeSelect\" value={viewMode} on:change={updateViewMode}>\r\n      <option value=\"battlemap\">桃 Battlemap (Tﾃ｡tico)</option>\r\n      <option value=\"cinematic\">汐 Cinematic (Imersivo)</option>\r\n    </select>\r\n  </div>\r\n  <p class=\"notes\">\r\n    Define se esta cena deve abrir automaticamente no Modo Cinemﾃ｡tico (Troca de\r\n    assets, Escala de Profundidade).\r\n  </p>\r\n</div>\r\n","import { toggleCinematicMode } from '../core/cinematic.js';\r\nimport ViewModeSelect from '../../components/ViewModeSelect.svelte';\r\n\r\nexport function registerUIHooks() {\r\n    Hooks.on('getSceneControlButtons', (controls) => {\r\n        // PROTEﾃﾃグ: Normaliza controls\r\n        const controlList = Array.isArray(controls) ? controls : Object.values(controls);\r\n\r\n        const tokenLayer = controlList.find(c => c.name === 'token');\r\n        if (tokenLayer && tokenLayer.tools) {\r\n            // Evita duplicatas\r\n            if (!tokenLayer.tools.some(t => t.name === 'cinematic')) {\r\n                tokenLayer.tools.push({\r\n                    name: 'cinematic',\r\n                    title: 'Modo Cinema 2.5D',\r\n                    icon: 'fas fa-film',\r\n                    toggle: true,\r\n                    active: document.body.classList.contains('cinematic-mode'),\r\n                    onClick: async (tog) => await toggleCinematicMode(tog)\r\n                });\r\n            }\r\n        }\r\n    });\r\n\r\n    Hooks.on('renderSceneConfig', (app, html) => {\r\n        const scene = app.document ?? app.object;\r\n        if (!scene) return;\r\n\r\n        // PROTEﾃﾃグ: V12+ usa HTMLElement, V11- usava JQuery\r\n        let root = html;\r\n        if (html.jquery) root = html[0];\r\n\r\n        if (!(root instanceof HTMLElement)) return;\r\n\r\n        // Procura botﾃ｣o submit de forma nativa e segura\r\n        const submitBtn = root.querySelector('button[type=\"submit\"]');\r\n\r\n        if (submitBtn) {\r\n            // Evita injeﾃｧﾃ｣o duplicada\r\n            if (root.querySelector('.storyteller-cinema-mount')) return;\r\n\r\n            const mountPoint = document.createElement('div');\r\n            mountPoint.className = 'form-group storyteller-cinema-mount';\r\n            submitBtn.parentElement.insertBefore(mountPoint, submitBtn); // Insert before submit\r\n\r\n            new ViewModeSelect({ target: mountPoint, props: { scene } });\r\n        }\r\n    });\r\n\r\n    // --- Interaction: Shift+Wheel SCALING (Hijack Rotation) ---\r\n    // Variﾃ｡vel de controle do Debounce (Escopo do Mﾃｳdulo)\r\n    let saveTimeout = null;\r\n\r\n    window.addEventListener('wheel', (event) => {\r\n        // Only active if Shift is held AND Cinematic Mode is ON\r\n        if (!event.shiftKey || !document.body.classList.contains('cinematic-mode')) return;\r\n\r\n        const hoverToken = canvas.tokens?.hover;\r\n        if (!hoverToken) return;\r\n\r\n        // STOP EVERYTHING: Prevent Foundry Rotation\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        event.stopImmediatePropagation();\r\n\r\n        // Calculate Delta (+/- 0.05)\r\n        const delta = event.deltaY > 0 ? -0.05 : 0.05;\r\n\r\n        // 1. Leitura: Tenta pegar do preview local, senﾃ｣o pega do banco, senﾃ｣o 1.0\r\n        let current = hoverToken._cinemaScalePreview ?? hoverToken.document.getFlag('storyteller-cinema', 'cinematicScale') ?? 1.0;\r\n\r\n        // 2. Cﾃ｡lculo com Limites\r\n        let newScale = Math.max(0.1, Math.min(5.0, current + delta));\r\n        newScale = Math.round(newScale * 100) / 100; // Arredonda 2 casas\r\n\r\n        // 3. ATUALIZAﾃﾃグ VISUAL INSTANTﾃNEA (Sem Banco de Dados)\r\n        hoverToken._cinemaScalePreview = newScale;\r\n        hoverToken.refresh(); // O depth.js vai ler o _cinemaScalePreview agora\r\n\r\n        // 4. GRAVAﾃﾃグ NO BANCO (Debounced / Atrasada)\r\n        if (saveTimeout) clearTimeout(saveTimeout);\r\n\r\n        saveTimeout = setTimeout(() => {\r\n            // Salva e limpa o preview (pois o banco jﾃ｡ terﾃ｡ o valor)\r\n            hoverToken.document.setFlag('storyteller-cinema', 'cinematicScale', newScale).then(() => {\r\n                hoverToken._cinemaScalePreview = null;\r\n            });\r\n            console.log(\"Storyteller Cinema | Salvo no Banco:\", newScale.toFixed(2));\r\n        }, 600); // Espera 600ms de inatividade\r\n\r\n    }, { passive: false, capture: true }); // Capture is key to running before Foundry\r\n}\r\n"],"names":["ctx"],"mappings":"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"}