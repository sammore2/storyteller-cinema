{"version":3,"file":"ui.js","sources":["../../src/scripts/hooks/ui.js"],"sourcesContent":["import { toggleCinematicMode } from '../core/cinematic.js';\r\n\r\n\r\n// --- UI HOOKS REGISTRATION ---\r\nexport function registerUIHooks() {\r\n    Hooks.on('getSceneControlButtons', (controls) => {\r\n        // PROTECTION: Normalize controls (can be Object or Array)\r\n        const controlList = Array.isArray(controls) ? controls : Object.values(controls);\r\n\r\n        const tokenLayer = controlList.find(c => c.name === 'token');\r\n        if (tokenLayer && tokenLayer.tools) {\r\n            tokenLayer.tools.push({\r\n                name: 'cinematic',\r\n                title: 'Storyteller Cinema 2.5D',\r\n                icon: 'fas fa-film',\r\n                toggle: true,\r\n                active: document.body.classList.contains('cinematic-mode'),\r\n                onClick: async (tog) => await toggleCinematicMode(tog)\r\n            });\r\n        }\r\n    });\r\n\r\n    Hooks.on('renderSceneConfig', (app, html) => {\r\n        const scene = app.document ?? app.object;\r\n        if (!scene) return;\r\n\r\n        // PROTECTION: V12+ uses HTMLElement, V11- used JQuery\r\n        let root = html;\r\n        if (html.jquery) root = html[0];\r\n\r\n        if (!(root instanceof HTMLElement)) return;\r\n\r\n        // Find submit button safely/natively\r\n        const submitBtn = root.querySelector('button[type=\"submit\"]');\r\n\r\n        if (submitBtn) {\r\n            // Prevent duplicate injection\r\n            if (root.querySelector('.storyteller-cinema-config')) return;\r\n\r\n            // Flags Update\r\n            const flags = scene.flags['storyteller-cinema'] || {};\r\n            const bgValue = flags.cinematicBg || \"\";\r\n            const viewMode = flags.viewMode || \"battlemap\";\r\n\r\n            const container = document.createElement('div');\r\n            container.className = 'storyteller-cinema-config'; // FIXED: Removed 'form-group' to prevent flexbox layout issues\r\n            container.style.borderTop = \"1px solid var(--color-border-light-2)\";\r\n            container.style.paddingTop = \"10px\";\r\n            container.style.marginTop = \"10px\";\r\n\r\n            // V13 Injection - MATCHING FOUNDRY STRUCTURE EXACTLY\r\n            // 1. Find the \"Appearance\" tab content (usually <div class=\"tab\" data-tab=\"appearance\">)\r\n            const appearanceTab = root.querySelector('.tab[data-tab=\"appearance\"]') || root.querySelector('.tab[data-tab=\"basic\"]'); // Fallback to basic\r\n\r\n            // If we found a tab, we append INSIDE it at the bottom.\r\n            const targetContainer = appearanceTab || submitBtn.closest('.form-footer').previousElementSibling;\r\n\r\n            // RE-WRITE HTML FOR MANUAL BUTTON (Safer for Injection)\r\n            container.innerHTML = `\r\n                <hr>\r\n                <h3 class=\"form-header\"><i class=\"fas fa-film\"></i> Storyteller Cinema</h3>\r\n                \r\n                <div class=\"form-group\">\r\n                    <label>Default View Mode</label>\r\n                    <div class=\"form-fields\">\r\n                        <select name=\"flags.storyteller-cinema.viewMode\">\r\n                            <option value=\"battlemap\" ${viewMode === 'battlemap' ? 'selected' : ''}>üìç Battlemap (Tactical)</option>\r\n                            <option value=\"cinematic\" ${viewMode === 'cinematic' ? 'selected' : ''}>üé¨ Cinematic (Immersive)</option>\r\n                        </select>\r\n                    </div>\r\n                    <p class=\"notes\">Defines how this scene should start.</p>\r\n                </div>\r\n\r\n                <div class=\"form-group\">\r\n                    <label>Cinematic Background</label>\r\n                    <div class=\"form-fields\">\r\n                        <button type=\"button\" class=\"file-picker\" data-type=\"imagevideo\" data-target=\"flags.storyteller-cinema.cinematicBg\" title=\"Browse Files\" tabindex=\"-1\">\r\n                            <i class=\"fas fa-file-import fa-fw\"></i>\r\n                        </button>\r\n                        <input class=\"image\" type=\"text\" name=\"flags.storyteller-cinema.cinematicBg\" placeholder=\"Image path...\" value=\"${bgValue}\">\r\n                    </div>\r\n                    <p class=\"notes\">Image displayed only in cinematic mode (replaces map).</p>\r\n                </div>\r\n            `;\r\n\r\n            // Append to the end of the form content (not footer)\r\n            targetContainer.appendChild(container);\r\n\r\n            // Re-activate listener logic (Cleaned)\r\n            const btn = container.querySelector(\"button.file-picker\");\r\n            if (btn) {\r\n                btn.onclick = (event) => {\r\n                    event.preventDefault();\r\n                    const FilePickerClass = foundry.applications?.apps?.FilePicker || FilePicker;\r\n                    const fp = new FilePickerClass({\r\n                        type: \"image\",\r\n                        current: bgValue,\r\n                        callback: (path) => {\r\n                            const input = container.querySelector(\"input[name='flags.storyteller-cinema.cinematicBg']\");\r\n                            if (input) {\r\n                                input.value = path;\r\n                                input.dispatchEvent(new Event('change', { bubbles: true }));\r\n                            }\r\n                        }\r\n                    });\r\n                    return fp.browse();\r\n                };\r\n            }\r\n\r\n            // Re-adjust height\r\n            app.setPosition({ height: \"auto\" });\r\n        }\r\n    });\r\n\r\n    // --- Interaction: Shift+Wheel SCALING (Hijack Rotation) ---\r\n    // Debounce Control Variable (Module Scope)\r\n    let saveTimeout = null;\r\n\r\n    window.addEventListener('wheel', (event) => {\r\n        // Only active if Shift is held AND Cinematic Mode is ON\r\n        if (!event.shiftKey || !document.body.classList.contains('cinematic-mode')) return;\r\n\r\n        const hoverToken = canvas.tokens?.hover;\r\n        if (!hoverToken) return;\r\n\r\n        // STOP EVERYTHING: Prevent Foundry Rotation\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        event.stopImmediatePropagation();\r\n\r\n        // Calculate Delta (+/- 0.05)\r\n        const delta = event.deltaY > 0 ? -0.05 : 0.05;\r\n\r\n        // 1. Read: Try local preview, else DB flag, else 1.0\r\n        let current = hoverToken._cinemaScalePreview ?? hoverToken.document.getFlag('storyteller-cinema', 'cinematicScale') ?? 1.0;\r\n\r\n        // 2. Calc with Limits\r\n        let newScale = Math.max(0.1, Math.min(5.0, current + delta));\r\n        newScale = Math.round(newScale * 100) / 100; // Round 2 decimal places\r\n\r\n        // 3. INSTANT VISUAL UPDATE (No DB yet)\r\n        hoverToken._cinemaScalePreview = newScale;\r\n        hoverToken.refresh(); // depth.js will read _cinemaScalePreview now\r\n\r\n        // 4. DB SAVE (Debounced / Delayed)\r\n        if (saveTimeout) clearTimeout(saveTimeout);\r\n\r\n        saveTimeout = setTimeout(() => {\r\n            // Save and clear preview (DB will have value)\r\n            hoverToken.document.setFlag('storyteller-cinema', 'cinematicScale', newScale).then(() => {\r\n                hoverToken._cinemaScalePreview = null;\r\n            });\r\n            console.log(\"Storyteller Cinema | Saved to DB:\", newScale.toFixed(2));\r\n        }, 600); // Wait 600ms inactivity\r\n\r\n    }, { passive: false, capture: true }); // Capture is key to running before Foundry\r\n\r\n    // --- Token Configuration Injection ---\r\n    Hooks.on('renderTokenConfig', (app, html, data) => {\r\n        // Validation: Ensure valid context\r\n        if (!app?.document || !html) return;\r\n\r\n        const flags = app.document.flags?.[\"storyteller-cinema\"] || {};\r\n        const cinematicTexture = flags.cinematicTexture || \"\";\r\n\r\n        // V13/V12 Compatibility: handle jQuery or HTMLElement\r\n        let root = html instanceof HTMLElement ? html : html[0];\r\n\r\n        // Find the \"Appearance\" tab content or the specific image group\r\n        // Strategy: We inject a new form-group after the main image path.\r\n        // Usually, the first form-group is Name, the second or third is Image.\r\n        // A safer bet is searching for the file-picker input and inserting after its group.\r\n\r\n        const appearanceTab = root.querySelector('.tab[data-tab=\"appearance\"]');\r\n        if (!appearanceTab) return;\r\n\r\n        // Verify if we already injected\r\n        if (appearanceTab.querySelector('input[name=\"flags.storyteller-cinema.cinematicTexture\"]')) return;\r\n\r\n        // Create the Form Group HTML\r\n        const formGroup = document.createElement(\"div\");\r\n        formGroup.className = \"form-group\";\r\n        formGroup.innerHTML = `\r\n            <label>Cinematic Portrait <span class=\"units\">(Optional)</span></label>\r\n            <div class=\"form-fields\">\r\n                <button type=\"button\" class=\"file-picker\" data-type=\"imagevideo\" data-target=\"flags.storyteller-cinema.cinematicTexture\" title=\"Browse Files\" tabindex=\"-1\">\r\n                    <i class=\"fas fa-file-import fa-fw\"></i>\r\n                </button>\r\n                <input class=\"image\" type=\"text\" name=\"flags.storyteller-cinema.cinematicTexture\" placeholder=\"path/to/image.webp\" value=\"${cinematicTexture}\">\r\n            </div>\r\n            <p class=\"notes\">If set, Token swaps to this image when Cinematic Mode is active.</p>\r\n        `;\r\n\r\n        // Insert at the top of the appearance tab (or specific location)\r\n        // Let's try to append securely or find a good anchor. \r\n        // In Core V12/V13, there are usually specific sections.\r\n        // We will prepend it to the appearance tab to be visible immediately or append it.\r\n        // Appending usually puts it at the bottom.\r\n        appearanceTab.appendChild(formGroup);\r\n\r\n        // Reactivate listeners for the new button (Foundry FilePicker logic requires manual binding if injected late)\r\n        // Actually, render hooks happen *after* listeners. We need to manually bind the file picker click.\r\n        const btn = formGroup.querySelector(\"button.file-picker\");\r\n        if (btn) {\r\n            btn.onclick = (event) => {\r\n                event.preventDefault();\r\n                // V13 Standard: Use namespaced FilePicker\r\n                const FilePickerClass = foundry.applications?.apps?.FilePicker || FilePicker;\r\n                const fp = new FilePickerClass({\r\n                    type: \"imagevideo\",\r\n                    current: cinematicTexture,\r\n                    callback: (path) => {\r\n                        formGroup.querySelector(\"input\").value = path;\r\n                        // Trigger change to ensure form detects update (if needed)\r\n                        // REMOVED dispatchEvent to prevent 'Cannot read properties of null' error in TokenConfig._onChangeForm\r\n                        // The value is set in DOM, so 'Update Token' will catch it.\r\n                    }\r\n                });\r\n                return fp.browse();\r\n            };\r\n        }\r\n\r\n        // Resize window to fit potentially new height\r\n        app.setPosition({ height: \"auto\" });\r\n    });\r\n}\r\n\r\n// === HUD BUTTON (Floating Top-Right) ===\r\nfunction createHUDButton() {\r\n    if (document.getElementById('storyteller-cinema-toggle')) return;\r\n\r\n    const btn = document.createElement('div');\r\n    btn.id = 'storyteller-cinema-toggle';\r\n    btn.innerHTML = '<i class=\"fas fa-film\"></i>';\r\n    btn.title = \"Toggle Cinematic Mode\";\r\n\r\n    // Initial State\r\n    if (document.body.classList.contains('cinematic-mode')) btn.classList.add('active');\r\n\r\n    btn.onclick = async () => {\r\n        const isActive = document.body.classList.contains('cinematic-mode');\r\n        await toggleCinematicMode(!isActive);\r\n        // Visual Feedback immediate\r\n        btn.classList.toggle('active', !isActive);\r\n    };\r\n\r\n    document.body.appendChild(btn);\r\n}\r\n\r\n// Ensure button exists on load\r\nHooks.on('ready', createHUDButton);\r\nHooks.on('canvasReady', createHUDButton);\r\n"],"names":["_a"],"mappings":"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"}