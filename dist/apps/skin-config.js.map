{"version":3,"file":"skin-config.js","sources":["../../src/scripts/apps/skin-config.js"],"sourcesContent":["const { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\r\n\r\nexport class SkinConfig extends HandlebarsApplicationMixin(ApplicationV2) {\r\n\r\n    constructor(options = {}) {\r\n        super(options);\r\n        this.selectedSkinId = 'default';\r\n        this.tempSkinData = null; // For editing before save\r\n    }\r\n\r\n    static get DEFAULT_OPTIONS() {\r\n        return {\r\n            tag: \"form\",\r\n            id: \"storyteller-cinema-skin-config\",\r\n            window: {\r\n                title: \"Storyteller Cinema - Skin Studio\",\r\n                icon: \"fas fa-film\",\r\n                resizable: true,\r\n                width: 800,\r\n                height: 600\r\n            },\r\n            position: {\r\n                width: 800,\r\n                height: 600\r\n            }\r\n        };\r\n    }\r\n\r\n    static get PARTS() {\r\n        return {\r\n            form: {\r\n                template: \"modules/storyteller-cinema/templates/skin-config.hbs\"\r\n            }\r\n        };\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* DATA PREPARATION                                                       */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    async _prepareContext(options) {\r\n        const skinManager = window.StorytellerCinema.skins;\r\n        const allSkins = skinManager.getSkins();\r\n        const activeSkinId = skinManager.activeSkin;\r\n\r\n        // Determine which skin we are editing\r\n        let currentSkin = this.tempSkinData;\r\n        if (!currentSkin) {\r\n            currentSkin = allSkins.find(s => s.id === this.selectedSkinId) || allSkins[0];\r\n            // Deep clone to avoid mutating live data directly\r\n            this.tempSkinData = JSON.parse(JSON.stringify(currentSkin));\r\n        }\r\n\r\n        return {\r\n            skins: allSkins,\r\n            activeSkin: activeSkinId,\r\n            selectedSkin: this.tempSkinData\r\n        };\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* EVENT HANDLERS                                                         */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    _onRender(context, options) {\r\n        // 0. Reactivity\r\n        if (!this._hookId) {\r\n            this._hookId = Hooks.on('storyteller-cinema-skins-updated', () => {\r\n                if (this.rendered) this.render();\r\n            });\r\n        }\r\n\r\n        // 1. Skin Selection\r\n        const skinItems = this.element.querySelectorAll('.skin-item');\r\n        skinItems.forEach(el => {\r\n            el.addEventListener('click', (ev) => {\r\n                const id = el.dataset.id;\r\n                this.selectedSkinId = id;\r\n                this.tempSkinData = null; // Reset temp data on switch\r\n                this.render();\r\n            });\r\n        });\r\n\r\n        // 1.5 Delete Button\r\n        const deleteBtns = this.element.querySelectorAll('.delete-skin');\r\n        deleteBtns.forEach(btn => {\r\n            btn.addEventListener('click', async (ev) => {\r\n                ev.stopPropagation(); // Stop selection\r\n                const id = btn.dataset.id;\r\n\r\n                const confirmed = await foundry.applications.api.DialogV2.confirm({\r\n                    window: { title: \"Delete Skin\" },\r\n                    content: `<p>Are you sure you want to delete this skin?</p>`,\r\n                    rejectClose: false,\r\n                    modal: true\r\n                });\r\n\r\n                if (confirmed) {\r\n                    await window.StorytellerCinema.skins.delete(id);\r\n                    // If we deleted the selected one, switch to default\r\n                    if (this.selectedSkinId === id) {\r\n                        this.selectedSkinId = 'default';\r\n                        this.tempSkinData = null;\r\n                        this.render();\r\n                    }\r\n                }\r\n            });\r\n        });\r\n\r\n        // 2. Input Changes (Live Update or State Update)\r\n        const inputs = this.element.querySelectorAll('input');\r\n        inputs.forEach(input => {\r\n            input.addEventListener('change', (ev) => this._onInputChange(ev));\r\n        });\r\n\r\n        // 3. Apply Button\r\n        const applyBtn = this.element.querySelector('.apply-skin-btn');\r\n        if (applyBtn) {\r\n            applyBtn.addEventListener('click', () => {\r\n                if (this.tempSkinData) {\r\n                    // Just update memory and apply (preview)\r\n                    window.StorytellerCinema.skins.register(this.tempSkinData, false);\r\n                    window.StorytellerCinema.skins.apply(this.tempSkinData.id);\r\n                    ui.notifications.info(\"Storyteller Cinema | Skin Applied (Not Saved)\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // 3.5 Save Button\r\n        const saveBtn = this.element.querySelector('.save-skin-btn');\r\n        if (saveBtn) {\r\n            saveBtn.addEventListener('click', () => {\r\n                if (this.tempSkinData) {\r\n                    // Update memory AND save to DB\r\n                    window.StorytellerCinema.skins.register(this.tempSkinData, true);\r\n                    window.StorytellerCinema.skins.apply(this.tempSkinData.id);\r\n                    ui.notifications.info(\"Storyteller Cinema | Skin Saved & Applied\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // 4. Create Button\r\n        const createBtn = this.element.querySelector('.create-skin-btn');\r\n        if (createBtn) {\r\n            createBtn.addEventListener('click', () => this._createNewSkin());\r\n        }\r\n\r\n        // 6. Export Button\r\n        const exportBtn = this.element.querySelector('.export-skin-btn');\r\n        if (exportBtn) {\r\n            exportBtn.addEventListener('click', (ev) => {\r\n                ev.stopPropagation(); // Avoid triggering parent clicks\r\n                // Get ID from the button itself (if in list) or use selected\r\n                const id = exportBtn.dataset.id || this.selectedSkinId;\r\n                window.StorytellerCinema.skins.exportSkin(id);\r\n            });\r\n        }\r\n\r\n        // 7. Import Button\r\n        const importBtn = this.element.querySelector('.import-skin-btn');\r\n        if (importBtn) {\r\n            importBtn.addEventListener('click', () => this._importSkinDialog());\r\n        }\r\n\r\n        // 5. File Pickers\r\n        const filePickers = this.element.querySelectorAll('.file-picker');\r\n        filePickers.forEach(btn => {\r\n            btn.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                const target = btn.dataset.target; // <--- RESTORED\r\n                const currentVal = this._getValue(this.tempSkinData, target);\r\n\r\n                // UX IMPROVEMENT: Default to User Data folder, NOT module folder (Permissions)\r\n                // This allows users to upload files without hitting \"Read Only\" errors.\r\n                const startPath = currentVal || 'storyteller-cinema/';\r\n\r\n                const FilePickerClass = foundry.applications?.apps?.FilePicker || FilePicker;\r\n                const filePicker = new FilePickerClass({\r\n                    type: \"image\",\r\n                    current: startPath,\r\n                    callback: (path) => {\r\n                        this._setValue(this.tempSkinData, target, path);\r\n                        this.render(); // Re-render to show value\r\n                    }\r\n                });\r\n                return filePicker.browse();\r\n            });\r\n        });\r\n    }\r\n\r\n    _onInputChange(event) {\r\n        event.preventDefault();\r\n        const input = event.currentTarget;\r\n        const field = input.name;\r\n        const value = input.value;\r\n\r\n        // Update temp data\r\n        this._setValue(this.tempSkinData, field, value);\r\n\r\n        // Optional: Live Preview logic hooks here\r\n        // window.StorytellerCinema.skins._preview(this.tempSkinData);\r\n    }\r\n\r\n    _createNewSkin() {\r\n        const newId = `custom-${Date.now()}`;\r\n        const newSkin = {\r\n            id: newId,\r\n            name: \"New Custom Skin\",\r\n            author: game.user.name,\r\n            version: \"1.0.0\",\r\n            options: {\r\n                theme: \"dark\",\r\n                styles: {\r\n                    \"--cinematic-bar-bg\": \"#000000\"\r\n                }\r\n            }\r\n        };\r\n\r\n        window.StorytellerCinema.skins.register(newSkin);\r\n        this.selectedSkinId = newId;\r\n        this.tempSkinData = null;\r\n        this.render();\r\n    }\r\n\r\n    _importSkinDialog() {\r\n        const input = document.createElement('input');\r\n        input.type = 'file';\r\n        input.accept = '.json';\r\n        input.onchange = (e) => this._processImportFile(e.target.files[0]);\r\n        input.click();\r\n    }\r\n\r\n    async _processImportFile(file) {\r\n        if (!file) return;\r\n        const reader = new FileReader();\r\n        reader.onload = async (e) => {\r\n            const content = e.target.result;\r\n            const imported = await window.StorytellerCinema.skins.importSkin(content);\r\n            if (imported) {\r\n                this.selectedSkinId = imported.id;\r\n                this.tempSkinData = null;\r\n                this.render();\r\n            }\r\n        };\r\n        reader.readAsText(file);\r\n    }\r\n\r\n    /* ---------------------------------------------------------------------- */\r\n    /* HELPERS                                                                */\r\n    /* ---------------------------------------------------------------------- */\r\n\r\n    // Dot notation setter\r\n    _setValue(obj, path, value) {\r\n        const keys = path.split('.');\r\n        let current = obj;\r\n        for (let i = 0; i < keys.length - 1; i++) {\r\n            if (!current[keys[i]]) current[keys[i]] = {};\r\n            current = current[keys[i]];\r\n        }\r\n        current[keys[keys.length - 1]] = value;\r\n    }\r\n\r\n    /** @override */\r\n    async _close(options) {\r\n        if (this._hookId) {\r\n            Hooks.off('storyteller-cinema-skins-updated', this._hookId);\r\n            this._hookId = null;\r\n        }\r\n        return super._close(options);\r\n    }\r\n\r\n    // Dot notation getter\r\n    _getValue(obj, path) {\r\n        return path.split('.').reduce((o, i) => o?.[i], obj);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}